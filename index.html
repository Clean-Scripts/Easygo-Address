<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Go | Address</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #ffffff; color: #1a1a1a; min-height: 100vh; }
        .banner-clip { clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%); }
        
        /* Map container */
        #map { 
            height: 400px; 
            width: 100%; 
            border-radius: 1.5rem; 
            overflow: hidden;
            border: 2px solid #f3f4f6;
        }
        
        /* Glass effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        
        /* Progress bar */
        .progress-container {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.5s ease;
        }
        
        /* Custom animations */
        @keyframes pulse-gentle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .pulse-gentle {
            animation: pulse-gentle 2s infinite;
        }
        
        /* Loading animation */
        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Main content spacing */
        .main-content { min-height: calc(100vh - 200px); }
        footer { margin-top: auto; }
        
        /* Service area boundaries */
        .service-area-boundary {
            stroke: #ef4444;
            stroke-width: 2;
            stroke-dasharray: 10, 10;
            fill: rgba(239, 68, 68, 0.1);
        }
        
        /* Special location styling */
        .special-location-marker {
            background: #8b5cf6;
            color: white;
            border-radius: 50%;
            padding: 8px;
            text-align: center;
            font-weight: bold;
        }
        
        /* Mobile fixes */
        @media (max-width: 768px) {
            .main-content {
                padding-bottom: 80px;
            }
            
            #map {
                height: 300px;
            }
            
            .glass-card {
                margin: 8px;
                padding: 20px;
                border-radius: 20px;
            }
            
            .progress-container {
                margin: 0 10px;
            }
            
            .mobile-stack {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
        }
        
        /* Address type emojis */
        .address-type-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .address-type-option:hover {
            background: #f3f4f6;
        }
        
        .address-type-option.selected {
            background: #3b82f6;
            color: white;
        }
        
        .address-type-emoji {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: #f3f4f6;
        }
        
        .address-type-option.selected .address-type-emoji {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Popup styles */
        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .popup-content {
            background: white;
            border-radius: 2rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        /* Custom marker for restaurant logo */
        .restaurant-logo-marker {
            width: 50px !important;
            height: 50px !important;
            border-radius: 50% !important;
            border: 3px solid white !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
            overflow: hidden !important;
            background: white !important;
        }
        
        .restaurant-logo-marker img {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain !important;
            padding: 5px !important;
        }
        
        /* Firebase status indicator */
        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        
        @keyframes slideDown {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, 20px); }
        }
        
        /* Status indicator for saved data */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-saved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">
    
    <!-- Empty Cart Overlay -->
    <div id="emptyCartOverlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-[2.5rem] p-8 md:p-10 max-w-md w-full shadow-2xl text-center border-2 border-gray-100">
            <div class="text-6xl mb-6">ðŸ›’</div>
            <h2 class="text-2xl font-black uppercase mb-4">Your Cart is Empty</h2>
            <p class="text-gray-600 mb-6 font-medium">Add delicious items to your cart before proceeding to Address Details.</p>
            <p class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-8">Redirecting in <span id="countdown" class="text-indigo-600 font-black">5</span> seconds...</p>
            <a href="https://clean-scripts.github.io/Easygo-Menu/" 
               class="inline-flex items-center gap-3 px-6 md:px-8 py-3 md:py-4 bg-indigo-600 text-white font-black uppercase rounded-[2rem] hover:bg-indigo-700 transition-all shadow-lg">
                <i class="fas fa-shopping-cart"></i>
                Back to Menu
            </a>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-[2rem] p-8 md:p-10 shadow-2xl text-center border-2 border-gray-100">
            <div class="loader mx-auto mb-6"></div>
            <p class="text-xl font-black uppercase mb-2">Processing</p>
            <p class="text-gray-600 text-sm font-medium">Please wait while we verify your details...</p>
        </div>
    </div>
    
    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status hidden">
        ðŸ”„ Connecting...
    </div>

    <!-- POPUP 1: Delivery Mode Selection -->
    <div id="deliveryModePopup" class="popup-overlay hidden">
        <div class="popup-content">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-motorcycle text-indigo-600 text-3xl"></i>
                </div>
                <h2 class="text-3xl font-black uppercase mb-2">Choose Your Option</h2>
                <p class="text-gray-600">How would you like to receive your order?</p>
            </div>
            
            <div class="space-y-4 mb-8">
                <div class="delivery-option border-2 border-indigo-500 bg-indigo-50 rounded-2xl p-6 cursor-pointer transition-all hover:shadow-lg"
                     onclick="selectDeliveryMode('delivery')">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-indigo-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-motorcycle text-white text-2xl"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="font-black text-xl uppercase">Home Delivery</h3>
                            <p class="text-indigo-600 font-bold">Delivered fresh to your doorstep</p>
                            <ul class="text-sm text-gray-600 mt-2 space-y-1">
                                <li>â€¢ â‚¹9 fixed delivery within 1km (any order!)</li>
                                <li>â€¢ Free delivery on orders above â‚¹199 (within 4km)</li>
                                <li>â€¢ Set your exact location on map</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="takeaway-option border-2 border-gray-200 rounded-2xl p-6 cursor-pointer transition-all hover:border-green-500 hover:shadow-lg"
                     onclick="selectDeliveryMode('takeaway')">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-gray-200 rounded-xl flex items-center justify-center">
                            <i class="fas fa-store text-gray-600 text-2xl"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="font-black text-xl uppercase">Takeaway</h3>
                            <p class="text-gray-600 font-bold">Pickup from Outlet</p>
                            <ul class="text-sm text-gray-600 mt-2 space-y-1">
                                <li>â€¢ No delivery charges</li>
                                <li>â€¢ OTP verification at pickup</li>
                                <li>â€¢ Prime Square, Omaxe City 1, Indore</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <button onclick="window.location.href='https://clean-scripts.github.io/Easygo-Menu/'" 
                        class="px-6 py-3 bg-gray-200 text-gray-800 rounded-2xl font-bold hover:bg-gray-300 transition-all">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Cart
                </button>
            </div>
        </div>
    </div>

    <!-- POPUP 2: Address Form (for Delivery) -->
    <div id="addressPopup" class="popup-overlay hidden">
        <div class="popup-content">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-indigo-100 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-map-marker-alt text-indigo-600 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black uppercase">Delivery Address</h2>
                        <p class="text-gray-500 text-sm">Enter your complete address</p>
                    </div>
                </div>
                <button onclick="closeAddressPopup()" class="p-2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="addressPopupContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- POPUP 3: Takeaway Form -->
    <div id="takeawayPopup" class="popup-overlay hidden">
        <div class="popup-content">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-store text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black uppercase">Takeaway Details</h2>
                        <p class="text-gray-500 text-sm">Pickup from our outlet</p>
                    </div>
                </div>
                <button onclick="closeTakeawayPopup()" class="p-2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="takeawayPopupContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header Banner -->
        <header class="relative mb-8">
            <div class="h-48 md:h-64 overflow-hidden banner-clip">
                <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/Banner.png" 
                     class="w-full h-full object-cover" alt="Easy Go Banner">
            </div>
            <div class="absolute -bottom-6 left-0 right-0 flex justify-center">
                <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                     class="h-24 md:h-32 w-24 md:w-32 rounded-full border-4 border-white shadow-xl bg-white p-1">
            </div>
        </header>

        <!-- Main Container -->
        <div class="max-w-6xl mx-auto px-4 md:px-6 pt-8 md:pt-10 pb-20 md:pb-12">
            <!-- Page Title -->
            <div class="text-center mb-8 md:mb-10">
                <h1 class="text-3xl md:text-5xl font-black uppercase tracking-tighter mb-2">Address & Delivery</h1>
                <p class="text-gray-500 uppercase text-sm font-bold tracking-widest">Step 2: Enter your details for Fresh Delivery</p>
            </div>
            
            <!-- Cart Summary -->
            <div class="glass-card rounded-[2rem] p-6 md:p-8 mb-8 md:mb-10 border-2 border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 md:w-14 h-12 md:h-14 bg-indigo-50 rounded-2xl flex items-center justify-center">
                            <i class="fas fa-shopping-cart text-indigo-600 text-lg md:text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs font-black text-gray-400 uppercase tracking-widest">Cart Total</p>
                            <p id="cart-total-badge" class="text-xl md:text-2xl font-black text-gray-900">â‚¹0</p>
                        </div>
                    </div>
                    
                    <!-- Clear All Button -->
                    <button onclick="clearAllData()" 
                            class="px-4 md:px-6 py-2 md:py-3 bg-red-100 text-red-600 rounded-2xl font-bold uppercase text-xs hover:bg-red-200 transition-all">
                        <i class="fas fa-trash mr-2"></i>Clear All
                    </button>
                </div>
                
                <!-- Session Info -->
                <div id="sessionInfo" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-xl hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            <span class="text-sm text-blue-700">Using saved details</span>
                        </div>
                        <span class="status-indicator status-saved">
                            <i class="fas fa-check-circle"></i>
                            Saved
                        </span>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row justify-between items-center pt-6 border-t border-gray-100 gap-4 md:gap-0">
                    <button onclick="window.location.href='https://clean-scripts.github.io/Easygo-Menu/'" 
                            class="px-6 py-3 bg-gray-900 text-white font-bold uppercase rounded-2xl hover:bg-black transition-all w-full md:w-auto">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Menu
                    </button>
                    
                    <button onclick="showDeliveryModePopup()" 
                            class="px-6 py-3 bg-indigo-600 text-white font-bold uppercase rounded-2xl hover:bg-indigo-700 transition-all w-full md:w-auto">
                        <i class="fas fa-edit mr-2"></i> Change Mode
                    </button>
                </div>
            </div>

            <!-- Selected Mode Display -->
            <div id="selectedModeDisplay" class="glass-card rounded-[2rem] p-6 md:p-8 mb-8 md:mb-10 border-2 border-gray-100 hidden">
                <!-- Content will be loaded based on selection -->
            </div>

            <!-- Map Section (Only for Delivery) -->
            <div id="mapSection" class="glass-card rounded-[2rem] p-6 md:p-8 mb-8 md:mb-10 border-2 border-gray-100 hidden">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-black uppercase mb-2 md:mb-0">Your Delivery Location</h2>
                    <div class="flex items-center gap-2 md:gap-4 text-xs font-bold text-gray-600">
                        <div class="flex items-center gap-1 md:gap-2">
                            <div class="w-2 md:w-3 h-2 md:h-3 bg-indigo-500 rounded-full"></div>
                            <span>Restaurant</span>
                        </div>
                        <div class="flex items-center gap-1 md:gap-2">
                            <div class="w-2 md:w-3 h-2 md:h-3 bg-purple-500 rounded-full"></div>
                            <span>Your Location</span>
                        </div>
                    </div>
                </div>
                
                <div id="map"></div>
                
                <!-- Location Actions -->
                <div class="grid grid-cols-2 gap-3 md:gap-4 mt-4">
                    <button id="useCurrentLocationBtn" 
                            class="flex items-center justify-center gap-2 md:gap-3 p-3 md:p-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 transition text-sm md:text-base">
                        <i class="fas fa-location-crosshairs"></i>
                        <span>Auto Location</span>
                    </button>
                    
                    <button id="manualLocationBtn" 
                            class="flex items-center justify-center gap-2 md:gap-3 p-3 md:p-4 bg-purple-600 text-white font-bold rounded-2xl hover:bg-purple-700 transition text-sm md:text-base">
                        <i class="fas fa-map-pin"></i>
                        <span>Click on Map</span>
                    </button>
                </div>
                
                <!-- Location Status -->
                <div id="locationStatus" class="mt-4 md:mt-6 p-4 md:p-5 bg-green-50 border-2 border-green-200 rounded-2xl hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 md:gap-4">
                            <i class="fas fa-check-circle text-xl md:text-2xl text-green-500"></i>
                            <div>
                                <p class="font-bold text-green-800 text-base md:text-lg">Location Set!</p>
                                <p class="text-sm text-gray-600">Distance: <span id="previewDistance" class="font-bold">-- km</span></p>
                            </div>
                        </div>
                        <button onclick="showAddressPopup()" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700">
                            Continue
                        </button>
                    </div>
                </div>
            </div>

            <!-- Delivery Charges Summary -->
            <div id="deliveryChargesCard" class="glass-card rounded-[2rem] p-6 md:p-8 mb-8 md:mb-10 border-2 border-gray-100 hidden">
                <div class="flex items-center gap-4 mb-6 md:mb-8">
                    <div class="w-12 md:w-14 h-12 md:h-14 bg-indigo-100 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-truck text-indigo-600 text-lg md:text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl md:text-2xl font-black uppercase">Delivery Summary</h2>
                        <p class="text-gray-500 text-sm font-medium">Your delivery charges breakdown</p>
                    </div>
                </div>
                
                <!-- Distance Display -->
                <div class="mb-6 md:mb-8 p-4 md:p-6 bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-2xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium text-gray-700 text-base md:text-lg">Distance from Outlet</p>
                            <p class="text-xs md:text-sm text-indigo-600 font-medium">Your delivery location</p>
                        </div>
                        <span id="distanceValue" class="text-2xl md:text-4xl font-black text-indigo-700">-- km</span>
                    </div>
                </div>
                
                <!-- Charges Breakdown -->
                <div class="space-y-3 md:space-y-4">
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-2xl">
                        <span class="font-bold text-gray-700">Delivery Charge</span>
                        <span id="totalCharge" class="font-black text-gray-900 text-2xl md:text-3xl">â‚¹0</span>
                    </div>
                    
                    <!-- Fixed â‚¹9 Delivery Message -->
                    <div id="fixedDeliveryMessage" class="p-4 bg-blue-50 border-2 border-blue-200 rounded-2xl hidden">
                        <div class="flex items-center gap-3 md:gap-4">
                            <i class="fas fa-tag text-blue-500 text-xl md:text-2xl"></i>
                            <div>
                                <p class="font-black text-blue-800 text-base md:text-lg uppercase">ðŸŽ¯ FIXED â‚¹9 DELIVERY!</p>
                                <p class="text-xs md:text-sm text-blue-700 font-medium">Within 1km from outlet - any order value!</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Free Delivery Offer -->
                    <div id="freeDeliveryOffer" class="p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl hidden">
                        <div class="flex items-center gap-3 md:gap-4">
                            <i class="fas fa-gift text-green-500 text-xl md:text-2xl"></i>
                            <div>
                                <p class="font-black text-green-800 text-base md:text-lg uppercase">ðŸŽ‰ FREE DELIVERY!</p>
                                <p class="text-xs md:text-sm text-green-700 font-medium">Your order qualifies for free delivery</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Button -->
                <button id="proceedToPaymentBtn" 
                        class="w-full mt-6 md:mt-10 flex items-center justify-center gap-3 md:gap-4 p-4 md:p-5 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black uppercase rounded-2xl hover:opacity-90 transition-all shadow-lg text-base md:text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        onclick="proceedToPayment()">
                    <i class="fas fa-check-circle text-lg md:text-xl"></i>
                    <span>Proceed to Payment</span>
                </button>
            </div>

            <!-- Takeaway Summary -->
            <div id="takeawaySummary" class="glass-card rounded-[2rem] p-6 md:p-8 mb-8 md:mb-10 border-2 border-gray-100 hidden">
                <div class="flex items-center gap-4 mb-6 md:mb-8">
                    <div class="w-12 md:w-14 h-12 md:h-14 bg-green-100 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-store text-green-600 text-lg md:text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl md:text-2xl font-black uppercase">Takeaway Summary</h2>
                        <p class="text-gray-500 text-sm font-medium">Pickup from our outlet</p>
                    </div>
                </div>
                
                <div class="mb-6 md:mb-8 p-4 md:p-6 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl">
                    <div class="space-y-3 md:space-y-4">
                        <div class="flex items-center gap-2 md:gap-3">
                            <i class="fas fa-map-marker-alt text-green-500"></i>
                            <div>
                                <p class="text-xs font-black text-gray-600 uppercase">Pickup Location</p>
                                <p class="font-bold text-green-700">Prime Square, Omaxe City 1, Indore</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 md:gap-3">
                            <i class="fas fa-clock text-green-500"></i>
                            <div>
                                <p class="text-xs font-black text-gray-600 uppercase">Pickup Time</p>
                                <p class="font-bold text-green-700">5:45 PM - 11:30 PM</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="proceedToPaymentTakeawayBtn" 
                        class="w-full flex items-center justify-center gap-3 md:gap-4 p-4 md:p-5 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black uppercase rounded-2xl hover:opacity-90 transition-all shadow-lg text-base md:text-lg"
                        onclick="proceedToTakeawayPayment()">
                    <i class="fas fa-check-circle text-lg md:text-xl"></i>
                    <span>Proceed to Payment</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-6 md:py-8">
        <div class="max-w-6xl mx-auto px-4 md:px-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-10 md:h-12 w-10 md:w-12 rounded-full bg-white p-1 mr-3">
                        <div>
                            <h2 class="text-lg md:text-xl font-bold">Easy Go</h2>
                            <p class="text-gray-400 text-xs md:text-sm">Delivering Freshness & Speed !</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400 text-xs md:text-sm mb-2">
                        Â© 2024 Easy Go | All Rights Reserved
                    </p>
                    <p class="text-gray-500 text-xs">
                        Serving daily from 5:45 PM to 10:30 PM
                    </p>
                    <div class="mt-3 md:mt-4">
                        <a href="https://clean-scripts.github.io/Easygo-Menu/" class="text-gray-400 hover:text-white text-xs md:text-sm mr-3 md:mr-4">View Menu</a>
                        <a href="https://clean-scripts.github.io/Easygo-Privacy/" class="text-gray-400 hover:text-white text-xs md:text-sm mr-3 md:mr-4">Privacy Policy</a>
                        <a href="https://clean-scripts.github.io/Easygo-Terms/" class="text-gray-400 hover:text-white text-xs md:text-sm">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

<script>
    // ====== FIREBASE CONFIGURATION ======
    const firebaseConfig = {
        apiKey: "AIzaSyCU_wJYBTwEwMZQ-iTYOjUZuEHEphA0DXc",
        authDomain: "easygo-10f4b.firebaseapp.com",
        databaseURL: "https://easygo-10f4b-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "easygo-10f4b",
        storageBucket: "easygo-10f4b.firebasestorage.app",
        messagingSenderId: "197660067542",
        appId: "1:197660067542:web:6c616efb479b122f1f6b77"
    };

    // ====== GLOBAL VARIABLES ======
    let map;
    let userMarker;
    let userLocation = null;
    let currentDeliveryMode = null;
    let database;
    let isFirebaseConnected = false;
    let firebaseInitialized = false;
    
    // Restaurant location (Prime Square, Indore)
    const primeSquareLocation = [22.7767737, 75.9605483];
    
    // Service Area Boundary (Indore approximate boundary)
    const indoreServiceArea = [
        [22.85, 75.70],  // Northwest
        [22.85, 76.10],  // Northeast
        [22.65, 76.10],  // Southeast
        [22.65, 75.70]   // Southwest
    ];
    
    // Special locations with predefined distances and charges
    const specialLocations = [
        {
            name: "TaskUs Indore - Rangreza",
            coords: [22.7500367, 75.9021075],
            distance: 1,
            charge: 20,
            isSpecial: false
        },
        {
            name: "Teleperformance Brilliant Sapphire",
            coords: [22.7633039, 75.8814454],
            distance: 1,
            charge: 20,
            isSpecial: false
        },
        {
            name: "L.I.G. Square",
            coords: [22.7336871, 75.8875409],
            distance: 1,
            charge: 30,
            isSpecial: false
        },
        {
            name: "Shree Vilas Palace (SPECIAL REQUEST)",
            coords: [22.737, 75.895],
            distance: 14,
            charge: 40,
            isSpecial: true,
            specialMessage: "Special delivery available for orders above â‚¹199 with â‚¹40 delivery charge"
        }
    ];
    
    // ====== STATE MANAGEMENT KEYS ======
    const STATE_KEYS = {
        DELIVERY_MODE: 'easygo-delivery-mode',
        ADDRESS_DATA: 'easygo-address-data',
        SAVED_ADDRESS: 'easygo-saved-address',
        USER_LOCATION: 'easygo-user-location',
        DELIVERY_DETAILS: 'easygo-delivery-details',
        IS_NEW_ORDER: 'easygo-is-new-order',
        ADDRESS_FIREBASE_ID: 'easygo-address-firebase-id',
        PAGE_SOURCE: 'easygo-page-source'
    };
    
    // ====== INITIALIZATION ======
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Easy Go Address Page Loading...");
        
        // Track where user came from
        trackPageSource();
        
        // Initialize Firebase (non-blocking)
        setTimeout(initializeFirebase, 1000);
        
        // Check cart first
        if (checkCartEmpty()) {
            console.log("Cart empty - stopping");
            return;
        }
        
        // Load cart total
        loadCartTotal();
        
        // Load saved state based on page source
        loadSavedStateBasedOnSource();
        
        console.log("Page initialization complete");
    });
    
    // ====== PAGE SOURCE TRACKING ======
    function trackPageSource() {
        const referrer = document.referrer;
        let source = 'direct';
        
        if (referrer.includes('Easygo-Menu')) {
            source = 'menu';
        } else if (referrer.includes('Easygo-Payment')) {
            source = 'payment';
        } else if (referrer.includes('Easygo-Track')) {
            source = 'track';
        }
        
        // Save current page source
        sessionStorage.setItem('currentPageSource', source);
        
        console.log("Page source detected:", source);
        return source;
    }
    
    // ====== STATE MANAGEMENT FUNCTIONS ======
    function loadSavedStateBasedOnSource() {
        try {
            const source = sessionStorage.getItem('currentPageSource') || 'direct';
            console.log("Loading state for source:", source);
            
            // Check if we have a saved order in progress
            const savedDeliveryMode = localStorage.getItem(STATE_KEYS.DELIVERY_MODE);
            const savedAddress = JSON.parse(localStorage.getItem(STATE_KEYS.ADDRESS_DATA) || '{}');
            const savedLocation = JSON.parse(localStorage.getItem(STATE_KEYS.USER_LOCATION) || 'null');
            
            console.log("Saved data found:", {
                deliveryMode: savedDeliveryMode,
                hasAddress: !!savedAddress.name,
                hasLocation: !!savedLocation
            });
            
            // RULE 1: If coming from payment page, NEVER show popup
            if (source === 'payment') {
                console.log("Coming from payment - restoring saved data");
                restoreSavedData(savedDeliveryMode, savedAddress, savedLocation);
                showSessionInfo(true);
                return;
            }
            
            // RULE 2: If coming from menu (new order) OR no saved data
            if (source === 'menu' || !savedDeliveryMode || !savedAddress.name) {
                console.log("New order or no saved data - showing mode selection");
                setTimeout(() => {
                    showDeliveryModePopup();
                }, 500);
                showSessionInfo(false);
                return;
            }
            
            // RULE 3: If coming directly or from track page with saved data
            if ((source === 'direct' || source === 'track') && savedDeliveryMode && savedAddress.name) {
                console.log("Returning user with saved data - restoring");
                restoreSavedData(savedDeliveryMode, savedAddress, savedLocation);
                showSessionInfo(true);
                return;
            }
            
            // Default fallback
            console.log("Default fallback - showing mode selection");
            setTimeout(() => {
                showDeliveryModePopup();
            }, 500);
            
        } catch (error) {
            console.error("Error loading saved state:", error);
            // Fallback to showing popup
            setTimeout(() => {
                showDeliveryModePopup();
            }, 500);
        }
    }
    
    function restoreSavedData(savedMode, savedAddress, savedLocation) {
        currentDeliveryMode = savedMode;
        
        if (savedLocation && savedMode === 'delivery') {
            userLocation = savedLocation;
        }
        
        // Update UI based on saved data
        updateSelectedModeDisplay();
        
        if (savedMode === 'delivery') {
            // Show map section
            document.getElementById('mapSection').classList.remove('hidden');
            document.getElementById('takeawaySummary').classList.add('hidden');
            
            // Initialize map and restore location
            setTimeout(() => {
                initMap();
                if (userLocation) {
                    // Set user location after map loads
                    setTimeout(() => {
                        setUserLocation(userLocation.lat, userLocation.lng);
                    }, 1000);
                }
                
                // Show delivery charges if location is set
                if (userLocation) {
                    document.getElementById('deliveryChargesCard').classList.remove('hidden');
                    updateDeliveryCharges();
                }
            }, 300);
            
            // If address is saved, auto-fill address popup when opened
            if (savedAddress.name) {
                // Address will be loaded when popup opens
            }
            
        } else {
            // Show takeaway section
            document.getElementById('mapSection').classList.add('hidden');
            document.getElementById('takeawaySummary').classList.remove('hidden');
        }
        
        // Show welcome back message
        showToast('Welcome back! Your saved details are restored âœ…');
    }
    
    function saveState() {
        try {
            // Save delivery mode
            if (currentDeliveryMode) {
                localStorage.setItem(STATE_KEYS.DELIVERY_MODE, currentDeliveryMode);
            }
            
            // Save user location
            if (userLocation) {
                localStorage.setItem(STATE_KEYS.USER_LOCATION, JSON.stringify(userLocation));
            }
            
            console.log("State saved successfully");
        } catch (error) {
            console.error("Error saving state:", error);
        }
    }
    
    function clearAllData() {
        if (confirm('Are you sure you want to clear all saved data? This will remove your address and delivery preferences.')) {
            // Clear all saved state
            Object.values(STATE_KEYS).forEach(key => {
                if (key !== 'PAGE_SOURCE') { // Don't clear page source
                    localStorage.removeItem(key);
                }
            });
            
            // Reset variables
            currentDeliveryMode = null;
            userLocation = null;
            
            // Reset UI
            document.getElementById('selectedModeDisplay').innerHTML = '';
            document.getElementById('selectedModeDisplay').classList.add('hidden');
            document.getElementById('mapSection').classList.add('hidden');
            document.getElementById('deliveryChargesCard').classList.add('hidden');
            document.getElementById('takeawaySummary').classList.add('hidden');
            document.getElementById('locationStatus').classList.add('hidden');
            document.getElementById('sessionInfo').classList.add('hidden');
            
            // Show popup for new selection
            showToast('All data cleared successfully');
            setTimeout(() => {
                showDeliveryModePopup();
            }, 1000);
        }
    }
    
    function showSessionInfo(isSaved) {
        const sessionInfo = document.getElementById('sessionInfo');
        if (isSaved) {
            sessionInfo.classList.remove('hidden');
        } else {
            sessionInfo.classList.add('hidden');
        }
    }
    
    // ====== FIREBASE INITIALIZATION ======
    function initializeFirebase() {
        try {
            // Check if already initialized
            if (firebase.apps.length === 0) {
                const app = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                firebaseInitialized = true;
                console.log("Firebase initialized successfully");
            } else {
                database = firebase.database();
                firebaseInitialized = true;
                console.log("Firebase already initialized");
            }
            
            // Monitor connection status
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                const statusElement = document.getElementById('firebaseStatus');
                
                if (snap.val() === true) {
                    isFirebaseConnected = true;
                    statusElement.textContent = "âœ… Firebase Connected";
                    statusElement.className = "firebase-status bg-green-500 text-white";
                    
                    setTimeout(() => {
                        statusElement.classList.add('hidden');
                    }, 3000);
                } else {
                    isFirebaseConnected = false;
                    statusElement.textContent = "âŒ Firebase Disconnected";
                    statusElement.className = "firebase-status bg-red-500 text-white";
                    statusElement.classList.remove('hidden');
                }
            });
            
            // Show initial connecting status
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.classList.remove('hidden');
            statusElement.textContent = "ðŸ”„ Connecting to Firebase...";
            statusElement.className = "firebase-status bg-yellow-500 text-white";
            
        } catch (error) {
            console.error("Firebase initialization error:", error);
            document.getElementById('firebaseStatus').classList.add('hidden');
        }
    }
    
    // ====== POPUP FUNCTIONS ======
    function showDeliveryModePopup() {
        document.getElementById('deliveryModePopup').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeDeliveryModePopup() {
        document.getElementById('deliveryModePopup').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    
    function showAddressPopup() {
        if (!userLocation && currentDeliveryMode === 'delivery') {
            alert('Please set your location on the map first');
            return;
        }
        
        // Load address form into popup
        document.getElementById('addressPopupContent').innerHTML = getAddressFormHTML();
        document.getElementById('addressPopup').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Load saved address if exists
        loadSavedAddress();
    }
    
    function closeAddressPopup() {
        document.getElementById('addressPopup').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    
    function showTakeawayPopup() {
        document.getElementById('takeawayPopupContent').innerHTML = getTakeawayFormHTML();
        document.getElementById('takeawayPopup').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Load saved takeaway data
        loadSavedTakeaway();
    }
    
    function closeTakeawayPopup() {
        document.getElementById('takeawayPopup').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    
    // ====== DELIVERY MODE SELECTION ======
    function selectDeliveryMode(mode) {
        currentDeliveryMode = mode;
        closeDeliveryModePopup();
        
        // Save state
        saveState();
        
        // Update UI based on selection
        updateSelectedModeDisplay();
        
        if (mode === 'delivery') {
            // Show map section
            document.getElementById('mapSection').classList.remove('hidden');
            document.getElementById('takeawaySummary').classList.add('hidden');
            
            // Initialize map with delay
            setTimeout(() => {
                initMap();
            }, 300);
            
            // Check if we have saved location
            const savedLocation = JSON.parse(localStorage.getItem(STATE_KEYS.USER_LOCATION) || 'null');
            if (savedLocation) {
                userLocation = savedLocation;
                setTimeout(() => {
                    setUserLocation(savedLocation.lat, savedLocation.lng);
                }, 1000);
            }
            
        } else {
            // Show takeaway section
            document.getElementById('mapSection').classList.add('hidden');
            document.getElementById('takeawaySummary').classList.remove('hidden');
            
            // Check if we have saved takeaway data
            const savedAddress = JSON.parse(localStorage.getItem(STATE_KEYS.ADDRESS_DATA) || '{}');
            if (savedAddress.name && savedAddress.phone) {
                // Already have data, don't show popup
                showToast('Using saved takeaway details');
            } else {
                // Show takeaway popup
                setTimeout(() => {
                    showTakeawayPopup();
                }, 300);
            }
        }
    }
    
    function updateSelectedModeDisplay() {
        const display = document.getElementById('selectedModeDisplay');
        
        if (currentDeliveryMode === 'delivery') {
            display.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center">
                            <i class="fas fa-motorcycle text-indigo-600 text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-black uppercase">Home Delivery Selected</h3>
                            <p class="text-indigo-600 font-medium">Set your location on map to continue</p>
                        </div>
                    </div>
                    <button onclick="showDeliveryModePopup()" 
                            class="px-4 py-2 bg-gray-200 text-gray-800 rounded-xl font-bold hover:bg-gray-300 transition">
                        Change Mode
                    </button>
                </div>
            `;
        } else {
            display.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center">
                            <i class="fas fa-store text-green-600 text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-black uppercase">Takeaway Selected</h3>
                            <p class="text-green-600 font-medium">Pickup from Prime Square, Indore</p>
                        </div>
                    </div>
                    <button onclick="showDeliveryModePopup()" 
                            class="px-4 py-2 bg-gray-200 text-gray-800 rounded-xl font-bold hover:bg-gray-300 transition">
                        Change Mode
                    </button>
                </div>
            `;
        }
        
        display.classList.remove('hidden');
    }
    
    // ====== MAP FUNCTIONS ======
    function initMap() {
        try {
            console.log("Initializing map...");
            
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.error("Map container not found");
                return;
            }
            
            // Clear existing map
            if (map) {
                try {
                    map.remove();
                } catch (e) {
                    console.log("Error removing old map:", e);
                }
                map = null;
            }
            
            // Initialize map
            map = L.map('map', {
                center: [22.72, 75.86],
                zoom: 12,
                zoomControl: true,
                scrollWheelZoom: true
            });
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19,
                minZoom: 10
            }).addTo(map);
            
            // Add restaurant marker with LOGO
            const logoIcon = L.divIcon({
                className: 'restaurant-logo-marker',
                html: `<img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" alt="Easy Go">`,
                iconSize: [50, 50],
                iconAnchor: [25, 50]
            });
            
            L.marker(primeSquareLocation, { icon: logoIcon })
                .addTo(map)
                .bindPopup('<b>EasyGo Restaurant</b><br>ðŸ“ Prime Square, Indore<br>ðŸ“ Our Kitchen')
                .openPopup();
            
            // Add service area boundary
            L.polygon(indoreServiceArea, {
                color: '#ef4444',
                fillColor: '#fef2f2',
                fillOpacity: 0.1,
                weight: 2,
                dashArray: '10, 10'
            }).addTo(map).bindPopup('<b>Indore Service Area</b>');
            
            // Add 1km circle for â‚¹9 delivery
            L.circle(primeSquareLocation, {
                color: '#10b981',
                fillColor: '#10b981',
                fillOpacity: 0.1,
                radius: 1000,
                weight: 2
            }).addTo(map).bindPopup('1km Fixed â‚¹9 Delivery Zone');
            
            // Add click event
            map.on('click', function(e) {
                if (currentDeliveryMode === 'delivery') {
                    setUserLocation(e.latlng.lat, e.latlng.lng);
                }
            });
            
            // Setup button event listeners
            setupMapEventListeners();
            
            // Force map resize after a delay
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    console.log("Map initialized successfully");
                }
            }, 500);
            
        } catch (error) {
            console.error("Error initializing map:", error);
        }
    }
    
    function setupMapEventListeners() {
        // Current location button
        document.getElementById('useCurrentLocationBtn').addEventListener('click', getCurrentLocation);
        
        // Manual location button
        document.getElementById('manualLocationBtn').addEventListener('click', function() {
            if (!map) {
                alert('Map is not ready yet. Please wait a moment.');
                return;
            }
            alert('Click anywhere on the map to set your exact delivery location');
        });
    }
    
    async function setUserLocation(lat, lng) {
        try {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            userLocation = { lat, lng };
            
            // Remove existing marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // Create new marker
            userMarker = L.marker([lat, lng], { 
                draggable: true,
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background: #8b5cf6; width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"></div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                })
            }).addTo(map);
            
            // Center map
            map.setView([lat, lng], 14);
            
            // Update delivery charges
            updateDeliveryCharges();
            
            // Show status
            document.getElementById('locationStatus').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('hidden');
            
            // Save state
            saveState();
            
            // Add dragend event
            userMarker.on('dragend', function() {
                const position = userMarker.getLatLng();
                userLocation = { lat: position.lat, lng: position.lng };
                updateDeliveryCharges();
                saveState();
            });
            
            console.log("User location set successfully");
            
        } catch (error) {
            console.error("Error setting user location:", error);
            alert("Error setting location. Please try again.");
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    }
    
    function getCurrentLocation() {
        if (currentDeliveryMode !== 'delivery') return;
        
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    await setUserLocation(lat, lng);
                },
                (error) => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    console.error("Geolocation error:", error);
                    
                    if (error.code === error.PERMISSION_DENIED) {
                        alert("Location access denied. Please click on the map.");
                    } else {
                        alert("Unable to get location. Please click on the map.");
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            document.getElementById('loadingOverlay').classList.add('hidden');
            alert("Geolocation not supported. Please click on the map.");
        }
    }
    
    // ====== FORM TEMPLATES ======
    function getAddressFormHTML() {
        return `
            <form id="addressForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Name -->
                    <div class="md:col-span-2">
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Full Name *</label>
                        <input type="text" 
                               id="name" 
                               required
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="Your good name please">
                    </div>
                    
                    <!-- Phone Number -->
                    <div class="md:col-span-2">
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Phone Number *</label>
                        <input type="tel" 
                               id="phone" 
                               required
                               pattern="[0-9]{10}"
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="10-digit WhatsApp number">
                    </div>
                    
                    <!-- Address Type -->
                    <div class="md:col-span-2">
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Address Type *</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <div class="address-type-option" onclick="selectAddressType('Flat', 'ðŸ¢')">
                                <div class="address-type-emoji">ðŸ¢</div>
                                <span>Flat</span>
                            </div>
                            <div class="address-type-option" onclick="selectAddressType('House', 'ðŸ ')">
                                <div class="address-type-emoji">ðŸ </div>
                                <span>House</span>
                            </div>
                            <div class="address-type-option" onclick="selectAddressType('Office', 'ðŸ¢')">
                                <div class="address-type-emoji">ðŸ’¼</div>
                                <span>Office</span>
                            </div>
                            <div class="address-type-option" onclick="selectAddressType('Hostel', 'ðŸ«')">
                                <div class="address-type-emoji">ðŸ«</div>
                                <span>Hostel</span>
                            </div>
                            <div class="address-type-option" onclick="selectAddressType('PG', 'ðŸ›ï¸')">
                                <div class="address-type-emoji">ðŸ›ï¸</div>
                                <span>P.G.</span>
                            </div>
                        </div>
                        <input type="hidden" id="addressType" required value="">
                    </div>
                    
                    <!-- House Number -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">House/Flat No. *</label>
                        <input type="text" 
                               id="houseNumber" 
                               required
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="House/Flat number">
                    </div>
                    
                    <!-- Floor Number -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Floor No.</label>
                        <input type="text" 
                               id="floorNumber"
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="Floor number (optional)">
                    </div>
                    
                    <!-- Locality -->
                    <div class="md:col-span-2">
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Locality / Area *</label>
                        <input type="text" 
                               id="locality" 
                               required
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="Your locality or area">
                    </div>
                    
                    <!-- Street -->
                    <div class="md:col-span-2">
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Street Name *</label>
                        <input type="text" 
                               id="street" 
                               required
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="Street name or landmark">
                    </div>
                    
                    <!-- Pincode -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Pincode *</label>
                        <input type="text" 
                               id="pincode" 
                               required
                               maxlength="6"
                               pattern="[0-9]{6}"
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="6-digit pincode">
                    </div>
                    
                    <!-- City -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">City</label>
                        <input type="text" 
                               id="city" 
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="Enter city">
                    </div>
                    
                    <!-- State -->
                    <div class="md:col-span-2">
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">State</label>
                        <input type="text" 
                               id="state" 
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="Enter state">
                    </div>
                </div>
                
                <div class="mt-6">
                    <button type="button" 
                            onclick="saveAddress()"
                            class="w-full flex items-center justify-center gap-3 p-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-black uppercase rounded-2xl hover:opacity-90 transition-all shadow-lg">
                        <i class="fas fa-check-circle"></i>
                        <span>Save Address & Continue</span>
                    </button>
                </div>
            </form>
        `;
    }
    
    function getTakeawayFormHTML() {
        return `
            <div class="mb-6 p-4 bg-green-50 border-2 border-green-200 rounded-2xl">
                <h3 class="font-bold text-green-800 mb-3 text-lg uppercase">ðŸ“ Pickup Information</h3>
                <div class="space-y-2 text-green-700">
                    <p class="flex items-center gap-2">
                        <i class="fas fa-map-marker-alt"></i>
                        <span><strong>Address:</strong> Prime Square, Omaxe City 1, Indore</span>
                    </p>
                    <p class="flex items-center gap-2">
                        <i class="fas fa-clock"></i>
                        <span><strong>Timings:</strong> 5:45 PM - 11:30 PM</span>
                    </p>
                    <p class="flex items-center gap-2">
                        <i class="fas fa-mobile-alt"></i>
                        <span><strong>OTP Verification:</strong> Required at pickup counter</span>
                    </p>
                </div>
            </div>
            
            <form id="takeawayForm" class="space-y-4">
                <div>
                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Your Name *</label>
                    <input type="text" 
                           id="takeaway-name" 
                           required
                           class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition font-medium"
                           placeholder="Your good name please">
                </div>
                
                <div>
                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Phone Number *</label>
                    <input type="tel" 
                           id="takeaway-phone" 
                           required
                           pattern="[0-9]{10}"
                           class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition font-medium"
                           placeholder="10-digit WhatsApp number">
                </div>
                
                <div class="mt-6">
                    <button type="button" 
                            onclick="saveTakeaway()"
                            class="w-full flex items-center justify-center gap-3 p-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black uppercase rounded-2xl hover:opacity-90 transition-all shadow-lg">
                        <i class="fas fa-check-circle"></i>
                        <span>Save & Continue</span>
                    </button>
                </div>
            </form>
        `;
    }
    
    // ====== ADDRESS TYPE SELECTION ======
    function selectAddressType(type, emoji) {
        // Remove selected class from all
        document.querySelectorAll('.address-type-option').forEach(el => {
            el.classList.remove('selected');
        });
        
        // Add selected class to clicked
        const options = document.querySelectorAll('.address-type-option');
        options.forEach(option => {
            if (option.textContent.includes(type)) {
                option.classList.add('selected');
            }
        });
        
        // Set hidden input value
        document.getElementById('addressType').value = type;
    }
    
    // ====== SAVE FUNCTIONS ======
    async function saveAddress() {
        if (!validateAddressForm()) {
            alert('Please fill all required fields marked with *');
            return;
        }
        
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        // Get address data
        const addressData = getAddressData();
        
        try {
            // Save to Firebase (or get offline ID)
            const firebaseId = await saveAddressToFirebase(addressData);
            
            // Save to localStorage
            localStorage.setItem(STATE_KEYS.ADDRESS_DATA, JSON.stringify(addressData));
            localStorage.setItem(STATE_KEYS.SAVED_ADDRESS, JSON.stringify(addressData));
            
            // Store the ID (Firebase or offline)
            if (firebaseId) {
                localStorage.setItem(STATE_KEYS.ADDRESS_FIREBASE_ID, firebaseId);
                console.log("Address saved with ID:", firebaseId);
            }
            
            // Close popup and show delivery charges
            closeAddressPopup();
            document.getElementById('deliveryChargesCard').classList.remove('hidden');
            
            // Save state
            saveState();
            
            // Show success message
            showToast('Address saved successfully! âœ…');
            
        } catch (error) {
            console.error("Error saving address:", error);
            // Even if save fails, save to localStorage and continue
            localStorage.setItem(STATE_KEYS.ADDRESS_DATA, JSON.stringify(addressData));
            localStorage.setItem(STATE_KEYS.SAVED_ADDRESS, JSON.stringify(addressData));
            
            closeAddressPopup();
            document.getElementById('deliveryChargesCard').classList.remove('hidden');
            saveState();
            showToast('Address saved âœ…');
        } finally {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    }
    
    async function saveTakeaway() {
        if (!validateTakeawayForm()) {
            alert('Please fill all required fields');
            return;
        }
        
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        // Save takeaway data
        const takeawayData = getTakeawayData();
        
        try {
            // Save to Firebase (or get offline ID)
            const firebaseId = await saveAddressToFirebase(takeawayData);
            
            // Save to localStorage
            localStorage.setItem(STATE_KEYS.ADDRESS_DATA, JSON.stringify(takeawayData));
            
            // Store the ID
            if (firebaseId) {
                localStorage.setItem(STATE_KEYS.ADDRESS_FIREBASE_ID, firebaseId);
                console.log("Takeaway saved with ID:", firebaseId);
            }
            
            // Close popup
            closeTakeawayPopup();
            
            // Save state
            saveState();
            
            // Show success message
            showToast('Takeaway details saved! âœ…');
            
        } catch (error) {
            console.error("Error saving takeaway:", error);
            // Save to localStorage anyway
            localStorage.setItem(STATE_KEYS.ADDRESS_DATA, JSON.stringify(takeawayData));
            closeTakeawayPopup();
            saveState();
            showToast('Takeaway details saved âœ…');
        } finally {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    }
    
    // ====== FIREBASE SAVE FUNCTION ======
    async function saveAddressToFirebase(addressData) {
        // If Firebase not connected, return a fake ID (offline mode)
        if (!isFirebaseConnected || !database) {
            console.log("Firebase offline - Address saved to localStorage only");
            const offlineId = 'offline_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            addressData.offlineId = offlineId;
            addressData.savedOffline = true;
            return offlineId;
        }
        
        try {
            const addressRef = database.ref('addresses').push();
            const addressKey = addressRef.key;
            
            const addressWithTimestamp = {
                ...addressData,
                id: addressKey,
                createdAt: Date.now(),
                cartTotal: parseFloat(localStorage.getItem('easygo-cart-items-total') || '0'),
                cartItems: JSON.parse(localStorage.getItem('easygo-cart') || '[]')
            };
            
            await addressRef.set(addressWithTimestamp);
            
            console.log("Address saved to Firebase with ID:", addressKey);
            
            return addressKey;
        } catch (error) {
            console.error("Error saving address to Firebase:", error);
            // Return offline ID if Firebase fails
            const offlineId = 'error_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            addressData.offlineId = offlineId;
            addressData.saveError = true;
            return offlineId;
        }
    }
    
    // ====== LOAD SAVED DATA ======
    function loadSavedAddress() {
        try {
            const savedAddress = JSON.parse(localStorage.getItem(STATE_KEYS.SAVED_ADDRESS) || '{}');
            
            if (savedAddress.name) {
                document.getElementById('name').value = savedAddress.name;
                document.getElementById('phone').value = savedAddress.phone;
                document.getElementById('addressType').value = savedAddress.addressType || '';
                document.getElementById('houseNumber').value = savedAddress.houseNumber || '';
                document.getElementById('floorNumber').value = savedAddress.floorNumber || '';
                document.getElementById('locality').value = savedAddress.locality || '';
                document.getElementById('street').value = savedAddress.street || '';
                document.getElementById('pincode').value = savedAddress.pincode || '';
                document.getElementById('city').value = savedAddress.city || '';
                document.getElementById('state').value = savedAddress.state || '';
                
                // Select address type visually
                if (savedAddress.addressType) {
                    const options = document.querySelectorAll('.address-type-option');
                    options.forEach(option => {
                        if (option.textContent.includes(savedAddress.addressType)) {
                            option.classList.add('selected');
                        }
                    });
                }
            }
        } catch (error) {
            console.error("Error loading saved address:", error);
        }
    }
    
    function loadSavedTakeaway() {
        try {
            const savedTakeaway = JSON.parse(localStorage.getItem(STATE_KEYS.ADDRESS_DATA) || '{}');
            
            if (savedTakeaway.name) {
                document.getElementById('takeaway-name').value = savedTakeaway.name;
                document.getElementById('takeaway-phone').value = savedTakeaway.phone;
            }
        } catch (error) {
            console.error("Error loading saved takeaway:", error);
        }
    }
    
    // ====== VALIDATION FUNCTIONS ======
    function validateAddressForm() {
        const requiredFields = ['name', 'phone', 'addressType', 'houseNumber', 'locality', 'street', 'pincode'];
        
        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field || !field.value.trim()) {
                alert(`Please fill the ${fieldId.replace(/([A-Z])/g, ' $1').toLowerCase()} field`);
                field?.focus();
                return false;
            }
        }
        
        const phone = document.getElementById('phone').value;
        if (!/^\d{10}$/.test(phone)) {
            alert('Please enter valid 10-digit phone number');
            document.getElementById('phone').focus();
            return false;
        }
        
        const pincode = document.getElementById('pincode').value;
        if (!/^\d{6}$/.test(pincode)) {
            alert('Please enter valid 6-digit pincode');
            document.getElementById('pincode').focus();
            return false;
        }
        
        return true;
    }
    
    function validateTakeawayForm() {
        const name = document.getElementById('takeaway-name').value;
        const phone = document.getElementById('takeaway-phone').value;
        
        if (!name.trim()) {
            alert('Please enter your name for takeaway');
            document.getElementById('takeaway-name').focus();
            return false;
        }
        
        if (!/^\d{10}$/.test(phone)) {
            alert('Please enter valid 10-digit phone number');
            document.getElementById('takeaway-phone').focus();
            return false;
        }
        
        return true;
    }
    
    // ====== DATA GETTERS ======
    function getAddressData() {
        const cartTotal = parseFloat(localStorage.getItem('easygo-cart-items-total') || '0');
        const cartItems = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
        const distanceData = JSON.parse(localStorage.getItem(STATE_KEYS.DELIVERY_DETAILS) || '{}');
        
        return {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            addressType: document.getElementById('addressType').value,
            houseNumber: document.getElementById('houseNumber').value,
            floorNumber: document.getElementById('floorNumber').value,
            locality: document.getElementById('locality').value,
            street: document.getElementById('street').value,
            pincode: document.getElementById('pincode').value,
            city: document.getElementById('city').value || 'Indore',
            state: document.getElementById('state').value || 'Madhya Pradesh',
            deliveryMode: 'delivery',
            location: userLocation,
            distance: distanceData.distance || '0',
            deliveryCharge: distanceData.charge || 0,
            cartTotal: cartTotal,
            itemCount: cartItems.length,
            createdAt: Date.now(),
            status: 'pending'
        };
    }
    
    function getTakeawayData() {
        const cartTotal = parseFloat(localStorage.getItem('easygo-cart-items-total') || '0');
        const cartItems = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
        
        return {
            name: document.getElementById('takeaway-name').value,
            phone: document.getElementById('takeaway-phone').value,
            deliveryMode: 'takeaway',
            pickupLocation: 'Prime Square, Omaxe City 1, Indore',
            cartTotal: cartTotal,
            itemCount: cartItems.length,
            createdAt: Date.now(),
            status: 'pending'
        };
    }
    
    // ====== DELIVERY CALCULATIONS ======
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    function calculateDeliveryCharges(distance) {
        const cartTotal = parseFloat(localStorage.getItem('easygo-cart-items-total') || '0');
        
        // FIXED â‚¹9 DELIVERY (including GST, no extra GST)
        if (distance <= 1) {
            return { 
                distance: distance.toFixed(2),
                charge: 9, // â‚¹9 including GST
                fixedDelivery: true,
                freeDelivery: false
            };
        }
        
        // Free delivery for orders above â‚¹199
        const freeDeliveryEligible = cartTotal > 199;
        
        // Special location: Shree Vilas Palace
        if (distance >= 13.5 && distance <= 14.5) {
            return {
                distance: "14.0",
                charge: 40, // â‚¹40 for orders > â‚¹199
                fixedDelivery: false,
                freeDelivery: false,
                specialLocation: true
            };
        }
        
        // Standard charges
        if (distance <= 4) {
            if (freeDeliveryEligible) {
                return {
                    distance: distance.toFixed(2),
                    charge: 0,
                    fixedDelivery: false,
                    freeDelivery: true
                };
            } else {
                return {
                    distance: distance.toFixed(2),
                    charge: 20,
                    fixedDelivery: false,
                    freeDelivery: false
                };
            }
        } else if (distance <= 6) {
            const charge = freeDeliveryEligible ? 30 : 50;
            return {
                distance: distance.toFixed(2),
                charge: charge,
                fixedDelivery: false,
                freeDelivery: false
            };
        } else if (distance <= 8) {
            const charge = freeDeliveryEligible ? 40 : 60;
            return {
                distance: distance.toFixed(2),
                charge: charge,
                fixedDelivery: false,
                freeDelivery: false
            };
        } else if (distance <= 10) {
            const charge = freeDeliveryEligible ? 50 : 70;
            return {
                distance: distance.toFixed(2),
                charge: charge,
                fixedDelivery: false,
                freeDelivery: false
            };
        }
        
        // Beyond 10km
        return {
            distance: distance.toFixed(2),
            charge: 0,
            fixedDelivery: false,
            freeDelivery: false,
            beyondRange: true
        };
    }
    
    function updateDeliveryCharges() {
        if (!userLocation) return;
        
        const distance = calculateDistance(
            primeSquareLocation[0], primeSquareLocation[1],
            userLocation.lat, userLocation.lng
        );
        
        const charges = calculateDeliveryCharges(distance);
        
        // Update UI
        document.getElementById('distanceValue').textContent = `${charges.distance} km`;
        document.getElementById('previewDistance').textContent = `${charges.distance} km`;
        document.getElementById('totalCharge').textContent = `â‚¹${charges.charge}`;
        
        // Show appropriate messages
        document.getElementById('fixedDeliveryMessage').classList.add('hidden');
        document.getElementById('freeDeliveryOffer').classList.add('hidden');
        
        if (charges.fixedDelivery) {
            document.getElementById('fixedDeliveryMessage').classList.remove('hidden');
        } else if (charges.freeDelivery) {
            document.getElementById('freeDeliveryOffer').classList.remove('hidden');
        }
        
        // Enable proceed button
        document.getElementById('proceedToPaymentBtn').disabled = false;
        document.getElementById('proceedToPaymentBtn').classList.remove('opacity-50', 'cursor-not-allowed');
        
        // Save delivery data
        localStorage.setItem(STATE_KEYS.DELIVERY_DETAILS, JSON.stringify({
            distance: charges.distance,
            charge: charges.charge,
            location: userLocation
        }));
    }
    
    // ====== PAYMENT FUNCTIONS ======
    async function proceedToPayment() {
        if (currentDeliveryMode === 'delivery') {
            if (!userLocation) {
                alert('Please set your delivery location first');
                return;
            }
            
            // Validate address in localStorage
            const address = JSON.parse(localStorage.getItem(STATE_KEYS.ADDRESS_DATA) || '{}');
            if (!address.name || !address.phone) {
                alert('Please save your address first');
                showAddressPopup();
                return;
            }
            
            // Check if we have minimum required data
            const requiredData = ['name', 'phone', 'deliveryMode'];
            const missingFields = requiredData.filter(field => !address[field]);
            
            if (missingFields.length > 0) {
                alert('Missing required information. Please save your address again.');
                showAddressPopup();
                return;
            }
            
            // Check cart
            const cart = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
            if (cart.length === 0) {
                alert('Your cart is empty');
                window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
                return;
            }
            
            // Mark as new order for next time
            localStorage.setItem(STATE_KEYS.IS_NEW_ORDER, 'true');
            
            // ALL CHECKS PASSED - Redirect to payment
            console.log("All checks passed. Redirecting to payment...");
            window.location.href = 'https://clean-scripts.github.io/Easygo-Payment/';
        }
    }
    
    async function proceedToTakeawayPayment() {
        const takeaway = JSON.parse(localStorage.getItem(STATE_KEYS.ADDRESS_DATA) || '{}');
        if (!takeaway.name || !takeaway.phone) {
            alert('Please save your takeaway details first');
            showTakeawayPopup();
            return;
        }
        
        // Check cart
        const cart = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
        if (cart.length === 0) {
            alert('Your cart is empty');
            window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
            return;
        }
        
        // Mark as new order for next time
        localStorage.setItem(STATE_KEYS.IS_NEW_ORDER, 'true');
        
        // Redirect to payment
        console.log("Takeaway ready. Redirecting to payment...");
        window.location.href = 'https://clean-scripts.github.io/Easygo-Payment/';
    }
    
    // ====== UTILITY FUNCTIONS ======
    function checkCartEmpty() {
        try {
            const cart = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
            const cartTotal = parseFloat(localStorage.getItem('easygo-cart-items-total') || '0');
            
            if (cart.length === 0 || cartTotal <= 0) {
                document.getElementById('emptyCartOverlay').classList.remove('hidden');
                
                let seconds = 5;
                const countdownElement = document.getElementById('countdown');
                countdownElement.textContent = seconds;
                
                const countdown = setInterval(() => {
                    seconds--;
                    countdownElement.textContent = seconds;
                    
                    if (seconds <= 0) {
                        clearInterval(countdown);
                        window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
                    }
                }, 1000);
                
                return true;
            }
            
            return false;
        } catch (error) {
            console.error("Error checking cart:", error);
            return false;
        }
    }
    
    function loadCartTotal() {
        const cartTotal = localStorage.getItem('easygo-cart-items-total') || '0';
        document.getElementById('cart-total-badge').textContent = `â‚¹${cartTotal}`;
    }
    
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.style.animation = 'slideDown 0.3s ease-out forwards';
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }
</script>
    
</body>
</html>

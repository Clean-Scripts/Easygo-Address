<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Go | Address & Delivery</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1a1a1a; min-height: 100vh; }
        
        /* Map container */
        #map { 
            height: 350px; 
            width: 100%; 
            border-radius: 1.5rem; 
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }
        
        /* Glass effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        
        /* Progress steps for mobile */
        .mobile-step {
            position: relative;
            padding-left: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .mobile-step-number {
            position: absolute;
            left: 0;
            top: 0;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Bottom action bar */
        .bottom-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e2e8f0;
            padding: 1rem;
            z-index: 40;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }
        
        /* Interactive step cards */
        .step-card {
            transition: all 0.3s ease;
            border-width: 2px;
        }
        
        .step-card.active {
            border-color: #4f46e5;
            background: #f5f3ff;
        }
        
        .step-card.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        /* Swipe animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease forwards;
        }
        
        /* Mobile bottom sheet */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 1.5rem 1.5rem 0 0;
            padding: 1.5rem;
            z-index: 50;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .bottom-sheet.open {
            transform: translateY(0);
        }
        
        .bottom-sheet-handle {
            width: 40px;
            height: 4px;
            background: #cbd5e1;
            border-radius: 2px;
            margin: 0 auto 1rem;
        }
        
        /* Location pin animation */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .bounce-animation {
            animation: bounce 2s infinite;
        }
        
        /* Loader */
        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-content {
                padding-bottom: 120px; /* Space for bottom action bar */
            }
            
            #map {
                height: 300px;
            }
            
            .mobile-only {
                display: block !important;
            }
            
            .desktop-only {
                display: none !important;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-only {
                display: none !important;
            }
            
            .desktop-only {
                display: block !important;
            }
        }
    </style>
</head>
<body class="antialiased">
    
    <!-- Empty Cart Overlay -->
    <div id="emptyCartOverlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl text-center border border-gray-100">
            <div class="text-5xl mb-4">üõí</div>
            <h2 class="text-xl font-black uppercase mb-3">Your Cart is Empty</h2>
            <p class="text-gray-600 mb-4 text-sm">Add delicious items to your cart before proceeding.</p>
            <a href="https://clean-scripts.github.io/Easygo-Menu/" 
               class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-all">
                <i class="fas fa-shopping-cart"></i>
                Back to Menu
            </a>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-2xl p-8 shadow-2xl text-center border border-gray-100">
            <div class="loader mx-auto mb-4"></div>
            <p class="font-bold text-gray-800">Processing</p>
            <p class="text-gray-600 text-sm mt-1">Please wait...</p>
        </div>
    </div>
    
    <!-- Mobile Bottom Sheet for Location -->
    <div id="locationBottomSheet" class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-map-marker-alt text-indigo-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-black text-gray-900 mb-2">Set Your Location</h3>
            <p class="text-gray-600 text-sm">We need your location to calculate delivery charges</p>
        </div>
        
        <div class="grid grid-cols-1 gap-3 mb-6">
            <button id="autoLocationBtn" 
                    class="flex items-center gap-4 p-4 bg-indigo-50 border-2 border-indigo-200 rounded-xl text-indigo-800 font-bold hover:bg-indigo-100 transition">
                <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-location-crosshairs text-indigo-600"></i>
                </div>
                <div class="text-left">
                    <p class="font-bold">Use Current Location</p>
                    <p class="text-sm text-indigo-600">Auto-detect with GPS</p>
                </div>
            </button>
            
            <button id="manualLocationBtn" 
                    class="flex items-center gap-4 p-4 bg-purple-50 border-2 border-purple-200 rounded-xl text-purple-800 font-bold hover:bg-purple-100 transition">
                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-map-pin text-purple-600"></i>
                </div>
                <div class="text-left">
                    <p class="font-bold">Tap on Map</p>
                    <p class="text-sm text-purple-600">Select exact location</p>
                </div>
            </button>
        </div>
        
        <button onclick="skipLocation()" 
                class="w-full py-3 text-gray-500 hover:text-gray-700 text-sm font-medium">
            Skip & Enter Address Manually
        </button>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Mobile Header -->
        <header class="mobile-only bg-white border-b border-gray-200 sticky top-0 z-30">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <button onclick="window.history.back()" class="p-2">
                        <i class="fas fa-arrow-left text-gray-700"></i>
                    </button>
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-8 w-8 rounded-full mr-2">
                        <span class="font-bold text-gray-900">Easy Go</span>
                    </div>
                    <div class="w-10"></div> <!-- Spacer -->
                </div>
                
                <!-- Mobile Progress -->
                <div class="mt-3">
                    <div class="flex items-center justify-between text-xs font-medium">
                        <span class="text-indigo-600">Step 1: Cart ‚úì</span>
                        <span class="text-gray-400">Step 2: Address</span>
                        <span class="text-gray-400">Step 3: Payment</span>
                    </div>
                    <div class="h-1.5 bg-gray-200 rounded-full mt-1 overflow-hidden">
                        <div class="h-full bg-indigo-600 rounded-full" style="width: 33%"></div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Desktop Header -->
        <header class="desktop-only relative mb-8">
            <div class="h-48 overflow-hidden">
                <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/Banner.png" 
                     class="w-full h-full object-cover" alt="Easy Go Banner">
            </div>
            <div class="absolute -bottom-6 left-0 right-0 flex justify-center">
                <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                     class="h-24 w-24 rounded-full border-4 border-white shadow-lg bg-white p-1">
            </div>
        </header>

        <div class="max-w-6xl mx-auto px-4 py-6 md:py-8">
            <!-- Page Title -->
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-black text-gray-900 mb-2">Delivery Address</h1>
                <p class="text-gray-600 text-sm md:text-base">Set location & enter details for fresh delivery</p>
            </div>

            <!-- Interactive Steps -->
            <div class="space-y-4 mb-8">
                <!-- Step 1: Delivery Mode -->
                <div id="step1" class="step-card active glass-card rounded-2xl p-5 border">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-indigo-600 text-white rounded-xl flex items-center justify-center font-bold">
                                1
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Choose Option</h3>
                                <p class="text-gray-600 text-sm">Delivery or Takeaway?</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transition-transform" id="step1Toggle"></i>
                    </div>
                    
                    <div id="step1Content" class="mt-4 pt-4 border-t border-gray-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="delivery-option border-2 border-indigo-500 bg-indigo-50 rounded-xl p-4 cursor-pointer transition-all hover:shadow-md"
                                 onclick="selectDeliveryMode('delivery')">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-indigo-600 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-motorcycle text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900">Home Delivery</h4>
                                        <p class="text-indigo-600 text-xs font-medium">‚Çπ9 fixed within 1km</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="takeaway-option border-2 border-gray-200 rounded-xl p-4 cursor-pointer transition-all hover:border-green-500 hover:shadow-md"
                                 onclick="selectDeliveryMode('takeaway')">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-gray-200 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-store text-gray-600 text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900">Takeaway</h4>
                                        <p class="text-gray-600 text-xs font-medium">Pickup from kitchen</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Location -->
                <div id="step2" class="step-card glass-card rounded-2xl p-5 border">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-gray-200 text-gray-400 rounded-xl flex items-center justify-center font-bold">
                                2
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-400">Set Location</h3>
                                <p class="text-gray-500 text-sm">Click on map to mark address</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>
                
                <!-- Step 3: Address Details -->
                <div id="step3" class="step-card glass-card rounded-2xl p-5 border">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-gray-200 text-gray-400 rounded-xl flex items-center justify-center font-bold">
                                3
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-400">Address Details</h3>
                                <p class="text-gray-500 text-sm">Complete your full address</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="space-y-6">
                <!-- Map Section (Initially Hidden) -->
                <div id="mapSection" class="hidden slide-in">
                    <div class="glass-card rounded-2xl p-5 border">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-map text-purple-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">Set Your Location</h3>
                                    <p class="text-gray-600 text-sm">Tap anywhere on the map</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="locationHelpBtn" class="p-2 text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                                <button onclick="closeMapSection()" class="p-2 text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-xl">
                            <p class="text-blue-800 text-sm flex items-center gap-2">
                                <i class="fas fa-info-circle"></i>
                                <span>Tip: Zoom in and tap exactly where you want delivery</span>
                            </p>
                        </div>
                        
                        <div id="map"></div>
                        
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button id="useCurrentBtn" 
                                    class="flex items-center justify-center gap-2 py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition">
                                <i class="fas fa-location-crosshairs"></i>
                                <span>Auto Location</span>
                            </button>
                            <button onclick="showLocationInstructions()" 
                                    class="flex items-center justify-center gap-2 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">
                                <i class="fas fa-question-circle"></i>
                                <span>Need Help?</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Location Status -->
                    <div id="locationStatus" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-2xl hidden">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500 text-xl"></i>
                            <div class="flex-1">
                                <p class="font-bold text-green-800">Location Set!</p>
                                <p class="text-green-700 text-sm">Distance: <span id="previewDistance" class="font-bold">-- km</span></p>
                            </div>
                            <button onclick="openAddressSection()" class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-sm font-medium">
                                Continue
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Address Form Section (Initially Hidden) -->
                <div id="addressSection" class="hidden slide-in">
                    <div class="glass-card rounded-2xl p-5 border">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-home text-indigo-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">Complete Address</h3>
                                    <p class="text-gray-600 text-sm">We've auto-filled from your location</p>
                                </div>
                            </div>
                            <button onclick="backToMapSection()" class="text-indigo-600 text-sm font-medium">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                Change Location
                            </button>
                        </div>
                        
                        <form id="addressForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                                    <input type="text" id="name" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none"
                                           placeholder="Your full name">
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                                    <input type="tel" id="phone" required pattern="[0-9]{10}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none"
                                           placeholder="10-digit WhatsApp number">
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Address Type *</label>
                                    <select id="addressType" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none bg-white">
                                        <option value="" disabled selected>Select type</option>
                                        <option value="Flat">Flat / Apartment</option>
                                        <option value="House">House</option>
                                        <option value="Office">Office</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">House/Flat No. *</label>
                                    <input type="text" id="houseNumber" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none"
                                           placeholder="e.g., A-102">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Floor (Optional)</label>
                                    <input type="text" id="floorNumber"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none"
                                           placeholder="e.g., 3rd floor">
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Street / Area *</label>
                                    <input type="text" id="street" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none"
                                           placeholder="Street name or locality">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pincode *</label>
                                    <input type="text" id="pincode" required maxlength="6" pattern="[0-9]{6}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none"
                                           placeholder="6-digit pincode">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">City *</label>
                                    <input type="text" id="city" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none"
                                           placeholder="Auto-filled">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">State *</label>
                                    <input type="text" id="state" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none"
                                           placeholder="Auto-filled">
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Instructions (Optional)</label>
                                    <textarea id="instructions" rows="2"
                                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none resize-none"
                                              placeholder="Gate code, landmark, etc."></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Takeaway Section (Initially Hidden) -->
                <div id="takeawaySection" class="hidden slide-in">
                    <div class="glass-card rounded-2xl p-5 border">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-store text-green-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Takeaway Details</h3>
                                <p class="text-gray-600 text-sm">Pickup from our kitchen</p>
                            </div>
                        </div>
                        
                        <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-xl">
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-map-marker-alt text-green-500"></i>
                                    <div>
                                        <p class="text-sm font-medium text-green-800">Pickup Location</p>
                                        <p class="text-green-700 font-bold">Prime Square, Omaxe City 1, Indore</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-clock text-green-500"></i>
                                    <div>
                                        <p class="text-sm font-medium text-green-800">Timings</p>
                                        <p class="text-green-700 font-bold">5:45 PM - 10:30 PM</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <form id="takeawayForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Your Name *</label>
                                <input type="text" id="takeawayName" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none"
                                       placeholder="Your full name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                                <input type="tel" id="takeawayPhone" required pattern="[0-9]{10}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none"
                                       placeholder="10-digit WhatsApp number">
                                <p class="text-gray-500 text-xs mt-1">For OTP verification at pickup</p>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Delivery Summary (Initially Hidden) -->
                <div id="deliverySummary" class="hidden slide-in">
                    <div class="glass-card rounded-2xl p-5 border">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-truck text-indigo-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Delivery Summary</h3>
                                <p class="text-gray-600 text-sm">Your charges breakdown</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl">
                                <span class="font-medium text-gray-700">Cart Total</span>
                                <span id="cartTotalDisplay" class="font-bold text-gray-900">‚Çπ0</span>
                            </div>
                            
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl">
                                <span class="font-medium text-gray-700">Distance</span>
                                <span id="distanceDisplay" class="font-bold text-indigo-600">-- km</span>
                            </div>
                            
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl">
                                <span class="font-medium text-gray-700">Delivery Charge</span>
                                <span id="deliveryChargeDisplay" class="font-bold text-gray-900">‚Çπ0</span>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-4">
                            <div class="flex justify-between items-center p-4 bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl">
                                <div>
                                    <p class="font-bold text-gray-900">Total Amount</p>
                                    <p class="text-indigo-600 text-sm">Inclusive of all taxes</p>
                                </div>
                                <span id="totalAmountDisplay" class="text-2xl font-black text-indigo-700">‚Çπ0</span>
                            </div>
                        </div>
                        
                        <!-- Special Offers -->
                        <div id="fixedDeliveryOffer" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl hidden">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-tag text-blue-500"></i>
                                <div>
                                    <p class="font-bold text-blue-800">üéØ Fixed ‚Çπ9 Delivery!</p>
                                    <p class="text-blue-700 text-sm">Within 1km from outlet - any order value!</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="freeDeliveryOffer" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-xl hidden">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-gift text-green-500"></i>
                                <div>
                                    <p class="font-bold text-green-800">üéâ Free Delivery!</p>
                                    <p class="text-green-700 text-sm">Order above ‚Çπ199 qualifies for free delivery</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Bottom Action Bar -->
    <div id="bottomActionBar" class="bottom-action-bar">
        <div class="flex items-center justify-between mb-3">
            <div>
                <p class="text-xs text-gray-500">Cart Total</p>
                <p id="mobileCartTotal" class="text-lg font-black text-gray-900">‚Çπ0</p>
            </div>
            <div>
                <p class="text-xs text-gray-500">Delivery</p>
                <p id="mobileDeliveryCharge" class="text-lg font-black text-indigo-600">--</p>
            </div>
        </div>
        
        <button id="mobileActionBtn" 
                class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-xl hover:opacity-90 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-arrow-right"></i>
            <span>Select Delivery Option</span>
        </button>
    </div>

    <!-- Footer -->
    <footer class="desktop-only bg-gray-900 text-white py-6 mt-12">
        <div class="max-w-6xl mx-auto px-4">
            <div class="text-center">
                <div class="flex items-center justify-center mb-4">
                    <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                         class="h-10 w-10 rounded-full bg-white p-1 mr-3">
                    <h2 class="text-lg font-bold">Easy Go</h2>
                </div>
                <p class="text-gray-400 text-sm mb-2">
                    ¬© 2024 Easy Go | All Rights Reserved
                </p>
                <p class="text-gray-500 text-xs mb-4">
                    Serving daily from 5:45 PM to 10:30 PM
                </p>
                <div class="flex justify-center gap-4">
                    <a href="https://clean-scripts.github.io/Easygo-Menu/" class="text-gray-400 hover:text-white text-sm">Menu</a>
                    <a href="https://clean-scripts.github.io/Easygo-Privacy/" class="text-gray-400 hover:text-white text-sm">Privacy</a>
                    <a href="https://clean-scripts.github.io/Easygo-Terms/" class="text-gray-400 hover:text-white text-sm">Terms</a>
                </div>
            </div>
        </div>
    </footer>

<script>
    // Global variables
    let map;
    let userMarker;
    let userLocation = null;
    let currentMode = null;
    let currentStep = 1;
    let isLocationSet = false;
    
    // Restaurant location
    const restaurantLocation = [22.7767737, 75.9605483];
    
    // ====== INITIALIZATION ======
    document.addEventListener('DOMContentLoaded', function() {
        // Check cart
        if (checkCartEmpty()) return;
        
        // Initialize
        loadCartTotal();
        setupEventListeners();
        
        // Auto-open location bottom sheet on mobile
        if (window.innerWidth < 768) {
            setTimeout(() => {
                openLocationBottomSheet();
            }, 500);
        }
        
        console.log("Easy Go Address Page Ready");
    });
    
    // ====== EVENT LISTENERS ======
    function setupEventListeners() {
        // Step toggles
        document.getElementById('step1Toggle').addEventListener('click', function() {
            toggleStep(1);
        });
        
        // Location buttons
        document.getElementById('autoLocationBtn').addEventListener('click', function() {
            closeLocationBottomSheet();
            getCurrentLocation();
        });
        
        document.getElementById('manualLocationBtn').addEventListener('click', function() {
            closeLocationBottomSheet();
            openMapSection();
        });
        
        // Map buttons
        document.getElementById('useCurrentBtn').addEventListener('click', getCurrentLocation);
        document.getElementById('locationHelpBtn').addEventListener('click', showLocationInstructions);
        
        // Mobile action button
        document.getElementById('mobileActionBtn').addEventListener('click', handleMobileAction);
        
        // Back button for mobile
        document.addEventListener('backbutton', goBackStep, false);
        
        // Keyboard support
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('locationBottomSheet').classList.contains('open')) {
                    closeLocationBottomSheet();
                } else if (document.getElementById('mapSection').classList.contains('hidden') === false) {
                    closeMapSection();
                }
            }
        });
    }
    
    // ====== STEP MANAGEMENT ======
    function toggleStep(stepNumber) {
        const step = document.getElementById(`step${stepNumber}`);
        const content = document.getElementById(`step${stepNumber}Content`);
        const icon = document.getElementById(`step${stepNumber}Toggle`);
        
        if (content) {
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }
    }
    
    function updateStepStatus(stepNumber, status) {
        const step = document.getElementById(`step${stepNumber}`);
        const stepNumberDiv = step.querySelector('.w-10.h-10');
        
        // Reset all step classes
        step.classList.remove('active', 'completed');
        stepNumberDiv.classList.remove('bg-indigo-600', 'bg-green-500', 'bg-gray-200');
        stepNumberDiv.classList.remove('text-white', 'text-gray-400');
        
        switch(status) {
            case 'active':
                step.classList.add('active');
                stepNumberDiv.classList.add('bg-indigo-600', 'text-white');
                break;
            case 'completed':
                step.classList.add('completed');
                stepNumberDiv.classList.add('bg-green-500', 'text-white');
                break;
            default:
                stepNumberDiv.classList.add('bg-gray-200', 'text-gray-400');
        }
    }
    
    // ====== DELIVERY MODE SELECTION ======
    function selectDeliveryMode(mode) {
        currentMode = mode;
        
        // Update UI
        document.querySelectorAll('.delivery-option, .takeaway-option').forEach(el => {
            el.classList.remove('border-indigo-500', 'bg-indigo-50', 'border-green-500');
            el.classList.add('border-gray-200');
        });
        
        if (mode === 'delivery') {
            document.querySelector('.delivery-option').classList.add('border-indigo-500', 'bg-indigo-50');
            document.querySelector('.delivery-option').classList.remove('border-gray-200');
            
            // Update step 1 status
            updateStepStatus(1, 'completed');
            updateStepStatus(2, 'active');
            
            // Show next step based on mobile/desktop
            if (window.innerWidth < 768) {
                openLocationBottomSheet();
                updateMobileActionButton('Set Location', 'map-marker-alt', false);
            } else {
                openMapSection();
            }
            
        } else {
            document.querySelector('.takeaway-option').classList.add('border-green-500');
            document.querySelector('.takeaway-option').classList.remove('border-gray-200');
            
            // Update steps
            updateStepStatus(1, 'completed');
            updateStepStatus(2, 'completed');
            updateStepStatus(3, 'active');
            
            // Show takeaway section
            document.getElementById('mapSection').classList.add('hidden');
            document.getElementById('addressSection').classList.add('hidden');
            document.getElementById('takeawaySection').classList.remove('hidden');
            document.getElementById('deliverySummary').classList.add('hidden');
            
            updateMobileActionButton('Proceed to Payment', 'arrow-right', false);
        }
        
        // Update bottom bar
        updateBottomBar();
    }
    
    // ====== LOCATION MANAGEMENT ======
    function openLocationBottomSheet() {
        document.getElementById('locationBottomSheet').classList.add('open');
        document.body.style.overflow = 'hidden';
    }
    
    function closeLocationBottomSheet() {
        document.getElementById('locationBottomSheet').classList.remove('open');
        document.body.style.overflow = 'auto';
    }
    
    function skipLocation() {
        closeLocationBottomSheet();
        openAddressSection();
        updateStepStatus(2, 'completed');
        updateStepStatus(3, 'active');
    }
    
    function openMapSection() {
        document.getElementById('mapSection').classList.remove('hidden');
        document.getElementById('addressSection').classList.add('hidden');
        document.getElementById('takeawaySection').classList.add('hidden');
        
        // Initialize map if not already
        if (!map) {
            setTimeout(initMap, 100);
        } else {
            map.invalidateSize();
        }
        
        updateMobileActionButton('Set Location', 'map-marker-alt', false);
    }
    
    function closeMapSection() {
        if (currentMode === 'delivery' && !isLocationSet) {
            if (confirm('You haven\'t set a location yet. Continue without location?')) {
                document.getElementById('mapSection').classList.add('hidden');
                openAddressSection();
            }
        } else {
            document.getElementById('mapSection').classList.add('hidden');
        }
    }
    
    function openAddressSection() {
        document.getElementById('mapSection').classList.add('hidden');
        document.getElementById('addressSection').classList.remove('hidden');
        document.getElementById('deliverySummary').classList.remove('hidden');
        
        updateStepStatus(2, 'completed');
        updateStepStatus(3, 'active');
        
        updateMobileActionButton('Proceed to Payment', 'arrow-right', false);
        updateBottomBar();
    }
    
    function backToMapSection() {
        openMapSection();
        updateStepStatus(3, '');
        updateStepStatus(2, 'active');
    }
    
    // ====== MAP FUNCTIONS ======
    function initMap() {
        try {
            const mapContainer = document.getElementById('map');
            if (!mapContainer) return;
            
            // Clear existing map
            if (map) {
                map.remove();
            }
            
            // Create map
            map = L.map('map', {
                center: [20.5937, 78.9629], // Center of India
                zoom: 4,
                zoomControl: true,
                scrollWheelZoom: true,
                dragging: true
            });
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            // Add restaurant marker
            L.marker(restaurantLocation, {
                icon: L.divIcon({
                    html: '<div class="bg-indigo-600 text-white p-2 rounded-full shadow-lg">üè™</div>',
                    iconSize: [40, 40]
                })
            }).addTo(map)
              .bindPopup('EasyGo Restaurant - Prime Square, Indore');
            
            // Add click event
            map.on('click', function(e) {
                setUserLocation(e.latlng.lat, e.latlng.lng);
            });
            
            // Add instruction
            L.control.attribution({
                position: 'bottomright',
                prefix: '<span style="color: #666; font-size: 11px;">Click to set location</span>'
            }).addTo(map);
            
            // Force resize
            setTimeout(() => map.invalidateSize(), 300);
            
        } catch (error) {
            console.error("Map error:", error);
        }
    }
    
    async function setUserLocation(lat, lng) {
        try {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            userLocation = { lat, lng };
            isLocationSet = true;
            
            // Remove old marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // Add new marker
            userMarker = L.marker([lat, lng], {
                draggable: true,
                icon: L.divIcon({
                    className: 'bounce-animation',
                    html: '<div style="background: #8b5cf6; width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"></div>',
                    iconSize: [40, 40]
                })
            }).addTo(map);
            
            // Center map
            map.setView([lat, lng], 16);
            
            // Auto-fill address
            await reverseGeocode(lat, lng);
            
            // Show success
            document.getElementById('locationStatus').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('hidden');
            
            // Update delivery charges
            updateDeliveryCharges();
            
            // Update mobile button
            updateMobileActionButton('Continue to Address', 'arrow-right', false);
            
            // Update drag event
            userMarker.on('dragend', async function() {
                const pos = userMarker.getLatLng();
                userLocation = { lat: pos.lat, lng: pos.lng };
                await reverseGeocode(pos.lat, pos.lng);
                updateDeliveryCharges();
            });
            
        } catch (error) {
            console.error("Location error:", error);
            document.getElementById('loadingOverlay').classList.add('hidden');
            alert("Error setting location. Please try again.");
        }
    }
    
    // ====== REVERSE GEOCODING ======
    async function reverseGeocode(lat, lng) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`
            );
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.address) {
                    const addr = data.address;
                    
                    // Fill fields
                    document.getElementById('city').value = addr.city || addr.town || addr.village || '';
                    document.getElementById('state').value = addr.state || '';
                    document.getElementById('street').value = addr.road || addr.neighbourhood || '';
                    
                    if (addr.postcode) {
                        document.getElementById('pincode').value = addr.postcode;
                    }
                    
                    // Make fields editable
                    document.getElementById('city').readOnly = false;
                    document.getElementById('state').readOnly = false;
                }
            }
        } catch (error) {
            console.error("Geocoding error:", error);
        }
    }
    
    // ====== LOCATION HELPERS ======
    function getCurrentLocation() {
        if (!navigator.geolocation) {
            alert("Geolocation not supported. Please tap on the map.");
            return;
        }
        
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        navigator.geolocation.getCurrentPosition(
            async (pos) => {
                await setUserLocation(pos.coords.latitude, pos.coords.longitude);
                closeLocationBottomSheet();
            },
            (error) => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert("Unable to get location. Please tap on the map.");
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }
    
    function showLocationInstructions() {
        alert("üìç How to set location:\n\n1. Zoom in/out using pinch or +/- buttons\n2. Tap exactly where you want delivery\n3. Drag the pin to adjust if needed\n4. Click 'Continue' when done");
    }
    
    // ====== DELIVERY CALCULATIONS ======
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    function calculateDeliveryCharges(distance) {
        const cartTotal = parseFloat(localStorage.getItem('easygo-cart-items-total') || '0');
        
        // Fixed ‚Çπ9 within 1km
        if (distance <= 1) {
            return { charge: 9, message: 'fixed' };
        }
        
        // Free delivery for orders > ‚Çπ199
        if (cartTotal > 199) {
            return { charge: 0, message: 'free' };
        }
        
        // Standard charges
        if (distance <= 4) return { charge: 20, message: 'standard' };
        if (distance <= 6) return { charge: 30, message: 'standard' };
        if (distance <= 8) return { charge: 40, message: 'standard' };
        if (distance <= 10) return { charge: 50, message: 'standard' };
        
        // Worldwide (‚Çπ5 per km, min ‚Çπ60)
        const charge = Math.max(60, Math.ceil(distance * 5));
        return { charge: charge, message: 'worldwide' };
    }
    
    function updateDeliveryCharges() {
        if (!userLocation) return;
        
        const distance = calculateDistance(
            restaurantLocation[0], restaurantLocation[1],
            userLocation.lat, userLocation.lng
        );
        
        const charges = calculateDeliveryCharges(distance);
        const cartTotal = parseFloat(localStorage.getItem('easygo-cart-items-total') || '0');
        const totalAmount = cartTotal + charges.charge;
        
        // Update displays
        document.getElementById('previewDistance').textContent = distance.toFixed(1) + ' km';
        document.getElementById('distanceDisplay').textContent = distance.toFixed(1) + ' km';
        document.getElementById('deliveryChargeDisplay').textContent = '‚Çπ' + charges.charge;
        document.getElementById('totalAmountDisplay').textContent = '‚Çπ' + totalAmount.toFixed(0);
        
        // Update mobile display
        document.getElementById('mobileDeliveryCharge').textContent = charges.charge === 0 ? 'FREE' : '‚Çπ' + charges.charge;
        
        // Show appropriate offer
        document.getElementById('fixedDeliveryOffer').classList.add('hidden');
        document.getElementById('freeDeliveryOffer').classList.add('hidden');
        
        if (charges.message === 'fixed') {
            document.getElementById('fixedDeliveryOffer').classList.remove('hidden');
        } else if (charges.message === 'free') {
            document.getElementById('freeDeliveryOffer').classList.remove('hidden');
        }
        
        // Save data
        localStorage.setItem('easygo-delivery', JSON.stringify({
            distance: distance.toFixed(1),
            charge: charges.charge,
            location: userLocation
        }));
    }
    
    // ====== MOBILE UI UPDATES ======
    function updateMobileActionButton(text, icon, disabled) {
        const btn = document.getElementById('mobileActionBtn');
        const iconEl = btn.querySelector('i');
        const textEl = btn.querySelector('span');
        
        iconEl.className = `fas fa-${icon}`;
        textEl.textContent = text;
        btn.disabled = disabled;
        
        if (disabled) {
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
    
    function updateBottomBar() {
        const cartTotal = localStorage.getItem('easygo-cart-items-total') || '0';
        document.getElementById('mobileCartTotal').textContent = '‚Çπ' + cartTotal;
        document.getElementById('cartTotalDisplay').textContent = '‚Çπ' + cartTotal;
    }
    
    function handleMobileAction() {
        if (!currentMode) {
            // No mode selected yet
            document.getElementById('step1Content').classList.remove('hidden');
            document.getElementById('step1Toggle').style.transform = 'rotate(180deg)';
            return;
        }
        
        if (currentMode === 'delivery') {
            if (!isLocationSet) {
                openLocationBottomSheet();
            } else {
                // Validate and proceed
                if (validateAddressForm()) {
                    saveAddress();
                    window.location.href = 'https://clean-scripts.github.io/Easygo-Payment/';
                }
            }
        } else {
            // Takeaway mode
            if (validateTakeawayForm()) {
                saveTakeaway();
                window.location.href = 'https://clean-scripts.github.io/Easygo-Payment/';
            }
        }
    }
    
    function goBackStep() {
        if (currentMode === 'delivery') {
            if (document.getElementById('addressSection').classList.contains('hidden') === false) {
                backToMapSection();
            } else if (document.getElementById('mapSection').classList.contains('hidden') === false) {
                document.getElementById('mapSection').classList.add('hidden');
                updateStepStatus(2, '');
                updateStepStatus(1, 'active');
            }
        }
    }
    
    // ====== VALIDATION ======
    function validateAddressForm() {
        const required = ['name', 'phone', 'addressType', 'houseNumber', 'street', 'pincode', 'city', 'state'];
        
        for (const fieldId of required) {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                field.focus();
                field.classList.add('border-red-500');
                setTimeout(() => field.classList.remove('border-red-500'), 2000);
                return false;
            }
        }
        
        // Validate phone
        const phone = document.getElementById('phone').value;
        if (!/^\d{10}$/.test(phone)) {
            alert('Please enter a valid 10-digit phone number');
            return false;
        }
        
        // Validate pincode
        const pincode = document.getElementById('pincode').value;
        if (!/^\d{6}$/.test(pincode)) {
            alert('Please enter a valid 6-digit pincode');
            return false;
        }
        
        return true;
    }
    
    function validateTakeawayForm() {
        const name = document.getElementById('takeawayName').value;
        const phone = document.getElementById('takeawayPhone').value;
        
        if (!name.trim()) {
            alert('Please enter your name for takeaway');
            return false;
        }
        
        if (!/^\d{10}$/.test(phone)) {
            alert('Please enter a valid 10-digit phone number');
            return false;
        }
        
        return true;
    }
    
    // ====== DATA SAVING ======
    function saveAddress() {
        const address = {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            addressType: document.getElementById('addressType').value,
            houseNumber: document.getElementById('houseNumber').value,
            floorNumber: document.getElementById('floorNumber').value,
            street: document.getElementById('street').value,
            pincode: document.getElementById('pincode').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            instructions: document.getElementById('instructions').value,
            deliveryMode: 'delivery',
            location: userLocation
        };
        
        localStorage.setItem('easygo-address', JSON.stringify(address));
        localStorage.setItem('easygo-saved-address', JSON.stringify(address));
    }
    
    function saveTakeaway() {
        const data = {
            name: document.getElementById('takeawayName').value,
            phone: document.getElementById('takeawayPhone').value,
            deliveryMode: 'takeaway'
        };
        
        localStorage.setItem('easygo-address', JSON.stringify(data));
    }
    
    // ====== CART FUNCTIONS ======
    function checkCartEmpty() {
        const cart = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
        const cartTotal = parseFloat(localStorage.getItem('easygo-cart-items-total') || '0');
        
        if (cart.length === 0 || cartTotal <= 0) {
            document.getElementById('emptyCartOverlay').classList.remove('hidden');
            
            let seconds = 5;
            const countdown = setInterval(() => {
                seconds--;
                document.getElementById('countdown').textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(countdown);
                    window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
                }
            }, 1000);
            
            return true;
        }
        
        return false;
    }
    
    function loadCartTotal() {
        const cartTotal = localStorage.getItem('easygo-cart-items-total') || '0';
        document.getElementById('mobileCartTotal').textContent = '‚Çπ' + cartTotal;
        document.getElementById('cartTotalDisplay').textContent = '‚Çπ' + cartTotal;
    }
    
    // Close bottom sheet when clicking outside
    document.getElementById('locationBottomSheet').addEventListener('click', function(e) {
        if (e.target === this) {
            closeLocationBottomSheet();
        }
    });
</script>
    
</body>
</html>

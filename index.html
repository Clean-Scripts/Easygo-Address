<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyGo Tracker - AI Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #video { width: 100%; border-radius: 1.5rem; background: #0f172a; }
        .scan-line { animation: scan 2s infinite linear; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-24">

    <header class="bg-white shadow-sm p-4 sticky top-0 z-50 border-b border-slate-100">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-2">
                <img src="https://i.ibb.co/XfXkXQy/Easy-Go-Logo.jpg" alt="Logo" class="h-10 w-10 rounded-full border border-blue-500">
                <h1 class="text-lg font-black text-slate-900">EasyGo <span class="text-blue-600">AI</span></h1>
            </div>
            <div id="ocrStatus" class="hidden text-[10px] font-bold text-blue-600 animate-pulse bg-blue-50 px-3 py-1 rounded-full">AI Scanning...</div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto p-4 space-y-4">
        
        <section class="relative bg-black rounded-[2rem] overflow-hidden shadow-2xl border-4 border-white aspect-video">
            <video id="video" autoplay playsinline></video>
            <div id="scannerLine" class="hidden absolute left-0 right-0 h-1 bg-blue-400 shadow-[0_0_15px_rgba(59,130,246,0.8)] scan-line z-10"></div>
            <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-4 z-20">
                <button onclick="startCamera()" class="bg-white/20 backdrop-blur-md text-white px-4 py-2 rounded-full text-[10px] font-bold border border-white/20">Switch</button>
                <button onclick="captureAndProcess()" class="bg-white h-14 w-14 rounded-full border-4 border-blue-600 flex items-center justify-center active:scale-90 transition-transform">
                    <div class="h-8 w-8 bg-blue-600 rounded-full"></div>
                </button>
            </div>
            <canvas id="canvas" class="hidden"></canvas>
        </section>

        <section class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm space-y-3">
            <input type="hidden" id="editId">
            <div class="grid grid-cols-2 gap-2">
                <select id="type" class="p-3 bg-slate-50 rounded-xl font-bold text-xs border-none">
                    <option value="Spent">ðŸ”´ Spent Bill</option>
                    <option value="Earned">ðŸŸ¢ Earned Bill</option>
                </select>
                <input type="text" id="orgName" placeholder="Organization Name" class="p-3 bg-slate-50 rounded-xl text-xs border-none font-bold">
            </div>

            <div class="grid grid-cols-2 gap-2">
                <input type="text" id="invNo" placeholder="Invoice / S.No" class="p-3 bg-slate-50 rounded-xl text-xs border-none">
                <input type="date" id="entryDate" class="p-3 bg-slate-50 rounded-xl text-xs border-none">
            </div>

            <input type="text" id="itemName" placeholder="Item Name" class="w-full p-3 bg-slate-50 rounded-xl text-xs border-none">

            <div class="grid grid-cols-3 gap-2">
                <input type="number" id="qty" value="1" oninput="calcTotal()" placeholder="Qty" class="p-3 bg-slate-50 rounded-xl text-xs text-center border-none">
                <input type="number" id="perCost" oninput="calcTotal()" placeholder="Rate" class="p-3 bg-slate-50 rounded-xl text-xs text-center border-none">
                <input type="number" id="gstAmount" oninput="calcTotal()" placeholder="GST â‚¹" class="p-3 bg-slate-50 rounded-xl text-xs text-center border-none">
            </div>

            <div class="grid grid-cols-2 gap-2">
                <input type="text" id="gstNo" placeholder="GST Number" class="p-3 bg-slate-50 rounded-xl text-[10px] border-none uppercase">
                <input type="text" id="contact" placeholder="Contact Info" class="p-3 bg-slate-50 rounded-xl text-[10px] border-none">
            </div>

            <div id="totalDisplay" class="p-4 bg-blue-600 text-white rounded-2xl font-black text-center text-lg">â‚¹ 0.00</div>
            
            <button onclick="saveRecord()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all uppercase tracking-widest text-xs">Save to Records</button>
        </section>

        <div id="history" class="space-y-3"></div>
    </main>

    <script>
        let db = JSON.parse(localStorage.getItem('easygo_ai_db')) || [];
        let capturedBase64 = null;
        const video = document.getElementById('video');

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
            } catch (err) { alert("Camera Error"); }
        }

        async function captureAndProcess() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 800; canvas.height = 1000;
            ctx.drawImage(video, 0, 0, 800, 1000);
            
            const fullImg = canvas.toDataURL('image/jpeg', 0.8);
            capturedBase64 = canvas.toDataURL('image/webp', 0.1); // 12KB Compressed Storage
            
            document.getElementById('scannerLine').classList.remove('hidden');
            document.getElementById('ocrStatus').classList.remove('hidden');

            const result = await Tesseract.recognize(fullImg, 'eng');
            const lines = result.data.text.split('\n');
            const text = result.data.text;

            // --- AI Extraction Logic ---
            // 1. Amount/Rate (Regex for numbers near "Total", "Rate", or "Amount")
            const amount = text.match(/(?:total|amount|net|sum|rate)[:\s]*(\d+[\.,]\d{2})/i);
            if(amount) document.getElementById('perCost').value = amount[1].replace(',', '');

            // 2. GST Number (Indian Format: 15 characters)
            const gst = text.match(/\d{2}[A-Z]{5}\d{4}[A-Z]{1}[A-Z\d]{1}[Z]{1}[A-Z\d]{1}/);
            if(gst) document.getElementById('gstNo').value = gst[0];

            // 3. Organization (Typically first few lines)
            if(lines.length > 0) document.getElementById('orgName').value = lines[0].trim().substring(0, 25);

            // 4. Contact/Phone
            const phone = text.match(/(?:\+91|0)?\d{10}/);
            if(phone) document.getElementById('contact').value = phone[0];

            // 5. Invoice Number
            const inv = text.match(/(?:inv|invoice|s\.no|bill|no)[:\s#]*([A-Z0-9\/-]+)/i);
            if(inv) document.getElementById('invNo').value = inv[1];

            document.getElementById('scannerLine').classList.add('hidden');
            document.getElementById('ocrStatus').classList.add('hidden');
            calcTotal();
            alert("Scan Complete. Verify details and select Spent or Earned.");
        }

        function calcTotal() {
            const qty = parseFloat(document.getElementById('qty').value) || 0;
            const rate = parseFloat(document.getElementById('perCost').value) || 0;
            const gst = parseFloat(document.getElementById('gstAmount').value) || 0;
            const final = (qty * rate) + gst;
            document.getElementById('totalDisplay').innerText = "â‚¹ " + final.toFixed(2);
        }

        function saveRecord() {
            const record = {
                id: Date.now(),
                date: document.getElementById('entryDate').value || new Date().toISOString().split('T')[0],
                type: document.getElementById('type').value,
                org: document.getElementById('orgName').value,
                item: document.getElementById('itemName').value || "Scanned Bill",
                total: parseFloat(document.getElementById('totalDisplay').innerText.replace('â‚¹ ', '')),
                img: capturedBase64,
                details: {
                    inv: document.getElementById('invNo').value,
                    gst: document.getElementById('gstNo').value,
                    contact: document.getElementById('contact').value
                }
            };
            db.push(record);
            localStorage.setItem('easygo_ai_db', JSON.stringify(db));
            render();
            alert("Saved Successfully!");
        }

        function render() {
            const container = document.getElementById('history');
            container.innerHTML = '';
            [...db].reverse().forEach(item => {
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-3xl flex items-center gap-3 border border-slate-100 shadow-sm">
                        ${item.img ? `<img src="${item.img}" class="w-12 h-12 rounded-xl object-cover">` : `<div class="w-12 h-12 bg-slate-100 rounded-xl"></div>`}
                        <div class="flex-1 min-w-0">
                            <h4 class="font-black text-[11px] truncate uppercase">${item.org || 'Local Vendor'}</h4>
                            <p class="text-[9px] text-slate-400 font-bold tracking-tighter">${item.item} | ${item.date}</p>
                            <p class="text-[8px] text-blue-500 font-bold">${item.details.gst ? 'GST: '+item.details.gst : ''}</p>
                        </div>
                        <p class="font-black text-xs ${item.type === 'Earned' ? 'text-green-600' : 'text-red-500'}">â‚¹${item.total.toFixed(2)}</p>
                    </div>`;
            });
        }

        document.getElementById('entryDate').valueAsDate = new Date();
        startCamera();
        render();
    </script>
</body>
</html>

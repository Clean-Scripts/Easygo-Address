<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <title>Easy Go | Address & Delivery</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #ffffff; color: #1a1a1a; min-height: 100vh; }
        
        /* Firebase Status */
        .firebase-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .popup-content {
            background: white;
            border-radius: 2rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        
        /* Map Container */
        #map {
            height: 300px;
            width: 100%;
            border-radius: 1rem;
            border: 2px solid #e5e7eb;
        }
        
        /* Address Type Selection */
        .address-type-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        
        .address-type-option:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .address-type-option.selected {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        
        .address-type-emoji {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: #f3f4f6;
        }
        
        .address-type-option.selected .address-type-emoji {
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status hidden">
        üîÑ Connecting...
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="bg-white rounded-2xl p-8 shadow-xl text-center">
            <div class="loader mb-4"></div>
            <p class="font-bold text-gray-700">Processing...</p>
            <p class="text-sm text-gray-500">Saving your address to database</p>
        </div>
    </div>

    <!-- Empty Cart Overlay -->
    <div id="emptyCartOverlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-[2.5rem] p-8 md:p-10 max-w-md w-full shadow-2xl text-center border-2 border-gray-100">
            <div class="text-6xl mb-6">üõí</div>
            <h2 class="text-2xl font-black uppercase mb-4">Your Cart is Empty</h2>
            <p class="text-gray-600 mb-6 font-medium">Add delicious items to your cart before proceeding to Address Details.</p>
            <p class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-8">Redirecting in <span id="countdown" class="text-indigo-600 font-black">5</span> seconds...</p>
            <a href="https://clean-scripts.github.io/Easygo-Menu/" 
               class="inline-flex items-center gap-3 px-6 md:px-8 py-3 md:py-4 bg-indigo-600 text-white font-black uppercase rounded-[2rem] hover:bg-indigo-700 transition-all shadow-lg">
                <i class="fas fa-shopping-cart"></i>
                Back to Menu
            </a>
        </div>
    </div>

    <!-- Delivery Mode Selection Popup -->
    <div id="deliveryModePopup" class="popup-overlay">
        <div class="popup-content">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-motorcycle text-indigo-600 text-3xl"></i>
                </div>
                <h2 class="text-3xl font-black uppercase mb-2">Choose Your Option</h2>
                <p class="text-gray-600">How would you like to receive your order?</p>
            </div>
            
            <div class="space-y-4 mb-8">
                <div class="delivery-option border-2 border-indigo-500 bg-indigo-50 rounded-2xl p-6 cursor-pointer transition-all hover:shadow-lg"
                     onclick="selectDeliveryMode('delivery')">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-indigo-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-motorcycle text-white text-2xl"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="font-black text-xl uppercase">Home Delivery</h3>
                            <p class="text-indigo-600 font-bold">Delivered fresh to your doorstep</p>
                            <ul class="text-sm text-gray-600 mt-2 space-y-1">
                                <li>‚Ä¢ ‚Çπ9 fixed delivery within 1km (any order!)</li>
                                <li>‚Ä¢ Free delivery on orders above ‚Çπ199 (within 4km)</li>
                                <li>‚Ä¢ Set your exact location on map</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="takeaway-option border-2 border-gray-200 rounded-2xl p-6 cursor-pointer transition-all hover:border-green-500 hover:shadow-lg"
                     onclick="selectDeliveryMode('takeaway')">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-gray-200 rounded-xl flex items-center justify-center">
                            <i class="fas fa-store text-gray-600 text-2xl"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="font-black text-xl uppercase">Takeaway</h3>
                            <p class="text-gray-600 font-bold">Pickup from Outlet</p>
                            <ul class="text-sm text-gray-600 mt-2 space-y-1">
                                <li>‚Ä¢ No delivery charges</li>
                                <li>‚Ä¢ OTP verification at pickup</li>
                                <li>‚Ä¢ Prime Square, Omaxe City 1, Indore</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <button onclick="goBackToCart()" 
                        class="px-6 py-3 bg-gray-200 text-gray-800 rounded-2xl font-bold hover:bg-gray-300 transition-all">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Cart
                </button>
            </div>
        </div>
    </div>

    <!-- Address Form Popup -->
    <div id="addressPopup" class="popup-overlay hidden">
        <div class="popup-content">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-indigo-100 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-map-marker-alt text-indigo-600 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black uppercase">Delivery Address</h2>
                        <p class="text-gray-500 text-sm">Enter your complete address</p>
                    </div>
                </div>
                <button onclick="closeAddressPopup()" class="p-2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addressForm" onsubmit="return saveAddress()">
                <div class="space-y-4">
                    <!-- Name -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Full Name *</label>
                        <input type="text" 
                               id="customerName" 
                               required
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="Your good name please">
                    </div>
                    
                    <!-- Phone -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Phone Number *</label>
                        <input type="tel" 
                               id="customerPhone" 
                               required
                               pattern="[0-9]{10}"
                               maxlength="10"
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="10-digit WhatsApp number">
                    </div>
                    
                    <!-- Address Type -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Address Type *</label>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="address-type-option" onclick="selectAddressType('home')">
                                <div class="address-type-emoji">üè†</div>
                                <span class="text-sm">Home</span>
                            </div>
                            <div class="address-type-option" onclick="selectAddressType('work')">
                                <div class="address-type-emoji">üíº</div>
                                <span class="text-sm">Work</span>
                            </div>
                            <div class="address-type-option" onclick="selectAddressType('other')">
                                <div class="address-type-emoji">üìç</div>
                                <span class="text-sm">Other</span>
                            </div>
                        </div>
                        <input type="hidden" id="addressType" required value="">
                    </div>
                    
                    <!-- House/Flat -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">House/Flat No. *</label>
                        <input type="text" 
                               id="houseNumber" 
                               required
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="House/Flat number">
                    </div>
                    
                    <!-- Street/Locality -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Street/Locality *</label>
                        <input type="text" 
                               id="street" 
                               required
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="Street name or locality">
                    </div>
                    
                    <!-- Area -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Area *</label>
                        <input type="text" 
                               id="area" 
                               required
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="Your area">
                    </div>
                    
                    <!-- City -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">City *</label>
                        <input type="text" 
                               id="city" 
                               required
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="City" value="Indore">
                    </div>
                    
                    <!-- Pincode -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Pincode *</label>
                        <input type="text" 
                               id="pincode" 
                               required
                               maxlength="6"
                               pattern="[0-9]{6}"
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="6-digit pincode">
                    </div>
                    
                    <!-- Landmark -->
                    <div>
                        <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Landmark (Optional)</label>
                        <input type="text" 
                               id="landmark"
                               class="w-full p-3 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                               placeholder="Nearby landmark">
                    </div>
                </div>
                
                <div class="mt-8">
                    <button type="submit" 
                            class="w-full flex items-center justify-center gap-3 p-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-black uppercase rounded-2xl hover:opacity-90 transition-all shadow-lg">
                        <i class="fas fa-check-circle"></i>
                        <span>Save Address & Continue</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header Banner -->
        <header class="relative mb-8">
            <div class="h-48 md:h-64 overflow-hidden">
                <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/Banner.png" 
                     class="w-full h-full object-cover" alt="Easy Go Banner">
            </div>
            <div class="absolute -bottom-6 left-0 right-0 flex justify-center">
                <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                     class="h-24 md:h-32 w-24 md:w-32 rounded-full border-4 border-white shadow-xl bg-white p-1">
            </div>
        </header>

        <!-- Main Container -->
        <div class="max-w-4xl mx-auto px-4 md:px-6 pt-8 md:pt-10 pb-12">
            <!-- Page Title -->
            <div class="text-center mb-8 md:mb-10">
                <h1 class="text-3xl md:text-5xl font-black uppercase tracking-tighter mb-2">Address & Delivery</h1>
                <p class="text-gray-500 uppercase text-sm font-bold tracking-widest">Step 2: Enter your details for Fresh Delivery</p>
            </div>
            
            <!-- Cart Summary -->
            <div class="bg-white rounded-3xl shadow-lg p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center">
                            <i class="fas fa-shopping-cart text-indigo-600 text-lg"></i>
                        </div>
                        <div>
                            <p class="text-xs font-black text-gray-400 uppercase tracking-widest">Cart Total</p>
                            <p id="cartTotal" class="text-xl font-black text-gray-900">‚Çπ0</p>
                        </div>
                    </div>
                    
                    <button onclick="changeDeliveryMode()" 
                            class="px-6 py-3 bg-gray-900 text-white rounded-2xl font-bold uppercase text-sm hover:bg-black transition-all">
                        <i class="fas fa-edit mr-2"></i>Change Mode
                    </button>
                </div>
            </div>

            <!-- Selected Mode Display -->
            <div id="selectedModeDisplay" class="hidden">
                <!-- Will be filled dynamically -->
            </div>

            <!-- Map Section (for Delivery) -->
            <div id="mapSection" class="bg-white rounded-3xl shadow-lg p-6 mb-8 hidden">
                <h2 class="text-xl font-black uppercase mb-4">üìç Your Delivery Location</h2>
                <div id="map" class="mb-4">
                    <div class="bg-gray-100 rounded-xl h-64 flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-4xl mb-4">üó∫Ô∏è</div>
                            <p class="font-bold text-gray-700">Map Loading...</p>
                            <p class="text-sm text-gray-500">Click "Use Current Location" or enter address manually</p>
                        </div>
                    </div>
                </div>
                
                <!-- Location Actions -->
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="getCurrentLocation()" 
                            class="flex items-center justify-center gap-2 p-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">
                        <i class="fas fa-location-crosshairs"></i>
                        <span>Use Current Location</span>
                    </button>
                    
                    <button onclick="openAddressPopup()" 
                            class="flex items-center justify-center gap-2 p-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700">
                        <i class="fas fa-map-pin"></i>
                        <span>Enter Address Manually</span>
                    </button>
                </div>
                
                <!-- Location Status -->
                <div id="locationStatus" class="mt-4 p-4 bg-green-50 border-2 border-green-200 rounded-xl hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-xl text-green-500"></i>
                            <div>
                                <p class="font-bold text-green-800">Location Set!</p>
                                <p class="text-sm text-gray-600">Address saved successfully</p>
                            </div>
                        </div>
                        <button onclick="proceedToPayment()" class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                            Proceed
                        </button>
                    </div>
                </div>
            </div>

            <!-- Takeaway Summary -->
            <div id="takeawaySummary" class="bg-white rounded-3xl shadow-lg p-6 hidden">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-store text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-black uppercase">Takeaway Summary</h2>
                        <p class="text-gray-500 text-sm">Pickup from our outlet</p>
                    </div>
                </div>
                
                <div class="mb-6 p-4 bg-green-50 border-2 border-green-200 rounded-xl">
                    <div class="space-y-3">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-green-500"></i>
                            <div>
                                <p class="text-xs font-black text-gray-600 uppercase">Pickup Location</p>
                                <p class="font-bold text-green-700">Prime Square, Omaxe City 1, Indore</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-clock text-green-500"></i>
                            <div>
                                <p class="text-xs font-black text-gray-600 uppercase">Pickup Time</p>
                                <p class="font-bold text-green-700">5:45 PM - 11:30 PM</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="saveTakeawayDetails()" 
                        class="w-full flex items-center justify-center gap-3 p-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black uppercase rounded-2xl hover:opacity-90 transition-all shadow-lg">
                    <i class="fas fa-check-circle"></i>
                    <span>Save & Proceed to Payment</span>
                </button>
            </div>

            <!-- Delivery Charges Summary -->
            <div id="deliveryChargesCard" class="bg-white rounded-3xl shadow-lg p-6 hidden">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-indigo-100 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-truck text-indigo-600 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-black uppercase">Delivery Summary</h2>
                        <p class="text-gray-500 text-sm">Your delivery charges breakdown</p>
                    </div>
                </div>
                
                <!-- Charges Breakdown -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-2xl">
                        <span class="font-bold text-gray-700">Delivery Charge</span>
                        <span id="deliveryCharge" class="font-black text-gray-900 text-2xl">‚Çπ0</span>
                    </div>
                    
                    <!-- Free Delivery Offer -->
                    <div id="freeDeliveryOffer" class="p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl hidden">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-gift text-green-500 text-xl"></i>
                            <div>
                                <p class="font-black text-green-800 text-lg uppercase">üéâ FREE DELIVERY!</p>
                                <p class="text-sm text-green-700">Your order qualifies for free delivery</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Button -->
                <button id="proceedToPaymentBtn" 
                        class="w-full mt-6 flex items-center justify-center gap-3 p-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black uppercase rounded-2xl hover:opacity-90 transition-all shadow-lg"
                        onclick="proceedToPayment()">
                    <i class="fas fa-check-circle"></i>
                    <span>Proceed to Payment</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-auto">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-12 w-12 rounded-full bg-white p-1 mr-3">
                        <div>
                            <h2 class="text-xl font-bold">Easy Go</h2>
                            <p class="text-gray-400 text-sm">Delivering Freshness & Speed !</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400 text-sm mb-2">
                        ¬© 2024 Easy Go | All Rights Reserved
                    </p>
                    <p class="text-gray-500 text-xs">
                        Serving daily from 5:45 PM to 10:30 PM
                    </p>
                    <div class="mt-4">
                        <a href="https://clean-scripts.github.io/Easygo-Menu/" class="text-gray-400 hover:text-white text-sm mr-4">View Menu</a>
                        <a href="https://clean-scripts.github.io/Easygo-Privacy/" class="text-gray-400 hover:text-white text-sm mr-4">Privacy Policy</a>
                        <a href="https://clean-scripts.github.io/Easygo-Terms/" class="text-gray-400 hover:text-white text-sm">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Firebase & Main JavaScript -->
    <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
        apiKey: "AIzaSyCU_wJYBTwEwMZQ-iTYOjUZuEHEphA0DXc",
        authDomain: "easygo-10f4b.firebaseapp.com",
        databaseURL: "https://easygo-10f4b-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "easygo-10f4b",
        storageBucket: "easygo-10f4b.firebasestorage.app",
        messagingSenderId: "197660067542",
        appId: "1:197660067542:web:6c616efb479b122f1f6b77"
    };

    // Firebase variables
    let database;
    let isFirebaseConnected = false;
    let currentDeliveryMode = null;
    let userLocation = null;
    let cartData = null;
    let cartTotal = 0;

    // ==================== FIREBASE INITIALIZATION ====================
    function initializeFirebase() {
        try {
            const app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            
            // Monitor connection status
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                const statusElement = document.getElementById('firebaseStatus');
                
                if (snap.val() === true) {
                    isFirebaseConnected = true;
                    statusElement.textContent = "‚úÖ Connected to Database";
                    statusElement.className = "firebase-status bg-green-500 text-white";
                    console.log("Firebase connected");
                    
                    // Hide after 3 seconds
                    setTimeout(() => {
                        statusElement.classList.add('hidden');
                    }, 3000);
                } else {
                    isFirebaseConnected = false;
                    statusElement.textContent = "‚ùå Database Disconnected";
                    statusElement.className = "firebase-status bg-red-500 text-white";
                }
                statusElement.classList.remove('hidden');
            });
            
            // Show initial connecting status
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.classList.remove('hidden');
            statusElement.textContent = "üîÑ Connecting to Database...";
            statusElement.className = "firebase-status bg-yellow-500 text-white";
            
        } catch (error) {
            console.error("Firebase initialization error:", error);
            document.getElementById('firebaseStatus').classList.add('hidden');
        }
    }

    // ==================== FIREBASE DATABASE FUNCTIONS ====================
    
    // Save address to Firebase
    async function saveAddressToFirebase(addressData) {
        showLoading();
        
        if (!isFirebaseConnected) {
            console.warn("Firebase not connected, saving to localStorage");
            localStorage.setItem('easygo-address', JSON.stringify(addressData));
            hideLoading();
            return false;
        }
        
        try {
            const addressRef = database.ref('addresses').push();
            const addressId = addressRef.key;
            
            const fullAddressData = {
                ...addressData,
                id: addressId,
                timestamp: Date.now(),
                date: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }),
                deliveryMode: currentDeliveryMode,
                cartTotal: cartTotal,
                cartItems: cartData
            };
            
            await addressRef.set(fullAddressData);
            
            console.log("Address saved to Firebase:", addressId);
            
            // Also save to users collection
            if (addressData.customerPhone) {
                await database.ref(`users/${addressData.customerPhone}`).update({
                    name: addressData.customerName,
                    lastAddress: addressData,
                    updatedAt: Date.now()
                });
            }
            
            // Save to localStorage as backup
            localStorage.setItem('easygo-address', JSON.stringify(addressData));
            localStorage.setItem('easygo-delivery-mode', currentDeliveryMode);
            
            hideLoading();
            return true;
            
        } catch (error) {
            console.error("Error saving address to Firebase:", error);
            
            // Fallback to localStorage
            localStorage.setItem('easygo-address', JSON.stringify(addressData));
            localStorage.setItem('easygo-delivery-mode', currentDeliveryMode);
            
            hideLoading();
            return false;
        }
    }

    // Save delivery charges to Firebase
    async function saveDeliveryChargesToFirebase(chargesData) {
        if (!isFirebaseConnected) return false;
        
        try {
            await database.ref('delivery_charges').push().set({
                ...chargesData,
                timestamp: Date.now(),
                date: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })
            });
            return true;
        } catch (error) {
            console.error("Error saving delivery charges:", error);
            return false;
        }
    }

    // Save takeaway details to Firebase
    async function saveTakeawayToFirebase(takeawayData) {
        showLoading();
        
        if (!isFirebaseConnected) {
            console.warn("Firebase not connected, saving to localStorage");
            localStorage.setItem('easygo-address', JSON.stringify(takeawayData));
            hideLoading();
            return false;
        }
        
        try {
            const takeawayRef = database.ref('takeaways').push();
            
            const fullTakeawayData = {
                ...takeawayData,
                id: takeawayRef.key,
                timestamp: Date.now(),
                date: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }),
                deliveryMode: 'takeaway',
                cartTotal: cartTotal,
                cartItems: cartData
            };
            
            await takeawayRef.set(fullTakeawayData);
            
            // Also save to users
            if (takeawayData.customerPhone) {
                await database.ref(`users/${takeawayData.customerPhone}`).update({
                    name: takeawayData.customerName,
                    updatedAt: Date.now()
                });
            }
            
            localStorage.setItem('easygo-address', JSON.stringify(takeawayData));
            localStorage.setItem('easygo-delivery-mode', 'takeaway');
            
            hideLoading();
            return true;
            
        } catch (error) {
            console.error("Error saving takeaway to Firebase:", error);
            
            // Fallback
            localStorage.setItem('easygo-address', JSON.stringify(takeawayData));
            localStorage.setItem('easygo-delivery-mode', 'takeaway');
            
            hideLoading();
            return false;
        }
    }

    // Get saved address from Firebase
    async function getSavedAddressFromFirebase(phone) {
        if (!isFirebaseConnected) return null;
        
        try {
            const snapshot = await database.ref(`users/${phone}`).once('value');
            const userData = snapshot.val();
            return userData ? userData.lastAddress : null;
        } catch (error) {
            console.error("Error getting address from Firebase:", error);
            return null;
        }
    }

    // ==================== CART FUNCTIONS ====================
    function checkCartEmpty() {
        try {
            // First try localStorage
            const cart = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
            cartData = cart;
            
            // Calculate total
            cartTotal = cart.reduce((total, item) => {
                const itemPrice = parseFloat(item.unitPrice) || parseFloat(item.price) || 0;
                const quantity = parseInt(item.quantity) || 1;
                return total + (itemPrice * quantity);
            }, 0);
            
            // Update cart total display
            document.getElementById('cartTotal').textContent = `‚Çπ${cartTotal.toFixed(2)}`;
            
            if (cart.length === 0 || cartTotal <= 0) {
                showEmptyCartOverlay();
                return true;
            }
            
            return false;
            
        } catch (error) {
            console.error("Error checking cart:", error);
            showEmptyCartOverlay();
            return true;
        }
    }

    function showEmptyCartOverlay() {
        const overlay = document.getElementById('emptyCartOverlay');
        overlay.classList.remove('hidden');
        
        let seconds = 5;
        const countdownElement = document.getElementById('countdown');
        countdownElement.textContent = seconds;
        
        const countdown = setInterval(() => {
            seconds--;
            countdownElement.textContent = seconds;
            
            if (seconds <= 0) {
                clearInterval(countdown);
                window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
            }
        }, 1000);
    }

    // ==================== DELIVERY MODE FUNCTIONS ====================
    function selectDeliveryMode(mode) {
        currentDeliveryMode = mode;
        
        // Close popup
        document.getElementById('deliveryModePopup').classList.add('hidden');
        document.body.style.overflow = 'auto';
        
        // Update selected mode display
        updateSelectedModeDisplay();
        
        if (mode === 'delivery') {
            // Show map section
            document.getElementById('mapSection').classList.remove('hidden');
            document.getElementById('takeawaySummary').classList.add('hidden');
            document.getElementById('deliveryChargesCard').classList.add('hidden');
            
        } else {
            // Show takeaway section
            document.getElementById('mapSection').classList.add('hidden');
            document.getElementById('takeawaySummary').classList.remove('hidden');
            document.getElementById('deliveryChargesCard').classList.add('hidden');
            
            // Load saved takeaway details
            loadSavedTakeawayDetails();
        }
    }

    function updateSelectedModeDisplay() {
        const display = document.getElementById('selectedModeDisplay');
        
        if (currentDeliveryMode === 'delivery') {
            display.innerHTML = `
                <div class="bg-white rounded-3xl shadow-lg p-6 mb-8">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-motorcycle text-indigo-600 text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-black uppercase">Home Delivery Selected</h3>
                                <p class="text-indigo-600 font-medium">Set your location or enter address to continue</p>
                            </div>
                        </div>
                        <button onclick="changeDeliveryMode()" 
                                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-xl font-bold hover:bg-gray-300 transition">
                            Change
                        </button>
                    </div>
                </div>
            `;
        } else {
            display.innerHTML = `
                <div class="bg-white rounded-3xl shadow-lg p-6 mb-8">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-store text-green-600 text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-black uppercase">Takeaway Selected</h3>
                                <p class="text-green-600 font-medium">Pickup from Prime Square, Indore</p>
                            </div>
                        </div>
                        <button onclick="changeDeliveryMode()" 
                                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-xl font-bold hover:bg-gray-300 transition">
                            Change
                        </button>
                    </div>
                </div>
            `;
        }
        
        display.classList.remove('hidden');
    }

    function changeDeliveryMode() {
        document.getElementById('deliveryModePopup').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    // ==================== ADDRESS FORM FUNCTIONS ====================
    function openAddressPopup() {
        // Load saved address if exists
        const savedAddress = JSON.parse(localStorage.getItem('easygo-address') || '{}');
        
        if (savedAddress.customerName) {
            document.getElementById('customerName').value = savedAddress.customerName || '';
            document.getElementById('customerPhone').value = savedAddress.customerPhone || '';
            document.getElementById('houseNumber').value = savedAddress.houseNumber || '';
            document.getElementById('street').value = savedAddress.street || '';
            document.getElementById('area').value = savedAddress.area || '';
            document.getElementById('city').value = savedAddress.city || 'Indore';
            document.getElementById('pincode').value = savedAddress.pincode || '';
            document.getElementById('landmark').value = savedAddress.landmark || '';
            
            // Select address type
            if (savedAddress.addressType) {
                selectAddressType(savedAddress.addressType);
            }
        }
        
        document.getElementById('addressPopup').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeAddressPopup() {
        document.getElementById('addressPopup').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function selectAddressType(type) {
        // Remove selected class from all
        document.querySelectorAll('.address-type-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Add selected class to clicked
        const options = document.querySelectorAll('.address-type-option');
        options.forEach(option => {
            if (option.querySelector('.text-sm').textContent.toLowerCase() === type.toLowerCase()) {
                option.classList.add('selected');
            }
        });
        
        // Set hidden input value
        document.getElementById('addressType').value = type;
    }

    async function saveAddress() {
        // Collect form data
        const addressData = {
            customerName: document.getElementById('customerName').value.trim(),
            customerPhone: document.getElementById('customerPhone').value.trim(),
            addressType: document.getElementById('addressType').value || 'home',
            houseNumber: document.getElementById('houseNumber').value.trim(),
            street: document.getElementById('street').value.trim(),
            area: document.getElementById('area').value.trim(),
            city: document.getElementById('city').value.trim(),
            pincode: document.getElementById('pincode').value.trim(),
            landmark: document.getElementById('landmark').value.trim(),
            location: userLocation,
            deliveryMode: 'delivery'
        };
        
        // Validation
        if (!addressData.customerName || !addressData.customerPhone || !addressData.houseNumber || 
            !addressData.street || !addressData.area || !addressData.pincode) {
            alert('Please fill all required fields marked with *');
            return false;
        }
        
        if (!/^\d{10}$/.test(addressData.customerPhone)) {
            alert('Please enter valid 10-digit phone number');
            return false;
        }
        
        if (!/^\d{6}$/.test(addressData.pincode)) {
            alert('Please enter valid 6-digit pincode');
            return false;
        }
        
        // Save to Firebase
        const saved = await saveAddressToFirebase(addressData);
        
        if (saved) {
            // Calculate delivery charges
            calculateDeliveryCharges();
            
            // Update UI
            document.getElementById('locationStatus').classList.remove('hidden');
            closeAddressPopup();
            
            // Show success message
            showToast('Address saved successfully!');
        }
        
        return false; // Prevent form submission
    }

    // ==================== DELIVERY CHARGES CALCULATION ====================
    function calculateDeliveryCharges() {
        let deliveryCharge = 0;
        let deliveryInfo = '';
        
        // Simple calculation based on cart total
        if (cartTotal > 199) {
            deliveryCharge = 0;
            deliveryInfo = 'Free delivery (order above ‚Çπ199)';
            document.getElementById('freeDeliveryOffer').classList.remove('hidden');
        } else {
            deliveryCharge = 30; // Default charge
            deliveryInfo = 'Standard delivery charge';
            document.getElementById('freeDeliveryOffer').classList.add('hidden');
        }
        
        // Update UI
        document.getElementById('deliveryCharge').textContent = `‚Çπ${deliveryCharge}`;
        
        // Save to localStorage for payment page
        localStorage.setItem('easygo-delivery-charge', deliveryCharge.toString());
        
        // Show delivery charges card
        document.getElementById('deliveryChargesCard').classList.remove('hidden');
        
        // Save to Firebase analytics
        if (isFirebaseConnected) {
            saveDeliveryChargesToFirebase({
                cartTotal: cartTotal,
                deliveryCharge: deliveryCharge,
                deliveryMode: 'delivery',
                isFreeDelivery: deliveryCharge === 0
            });
        }
    }

    // ==================== TAKEAWAY FUNCTIONS ====================
    function loadSavedTakeawayDetails() {
        const savedTakeaway = JSON.parse(localStorage.getItem('easygo-address') || '{}');
        
        if (savedTakeaway.customerName && savedTakeaway.customerPhone) {
            // Pre-fill form if we have data
        }
    }

    async function saveTakeawayDetails() {
        const name = prompt('Enter your name for pickup:', '');
        const phone = prompt('Enter your phone number:', '');
        
        if (!name || !phone) {
            alert('Name and phone number are required for pickup');
            return;
        }
        
        if (!/^\d{10}$/.test(phone)) {
            alert('Please enter valid 10-digit phone number');
            return;
        }
        
        const takeawayData = {
            customerName: name,
            customerPhone: phone,
            deliveryMode: 'takeaway',
            pickupLocation: 'Prime Square, Omaxe City 1, Indore',
            pickupTiming: '5:45 PM - 11:30 PM'
        };
        
        // Save to Firebase
        const saved = await saveTakeawayToFirebase(takeawayData);
        
        if (saved) {
            // Proceed to payment
            proceedToPayment();
        }
    }

    // ==================== PAYMENT FUNCTIONS ====================
    function proceedToPayment() {
        // Validate address/takeaway details
        const addressData = JSON.parse(localStorage.getItem('easygo-address') || '{}');
        
        if (currentDeliveryMode === 'delivery' && !addressData.customerPhone) {
            alert('Please save your delivery address first');
            openAddressPopup();
            return;
        }
        
        if (currentDeliveryMode === 'takeaway' && !addressData.customerPhone) {
            alert('Please enter your takeaway details first');
            saveTakeawayDetails();
            return;
        }
        
        // Save cart total to localStorage for payment page
        localStorage.setItem('easygo-cart-total', cartTotal.toString());
        
        // Calculate and save delivery charges if delivery
        if (currentDeliveryMode === 'delivery') {
            const deliveryCharge = cartTotal > 199 ? 0 : 30;
            localStorage.setItem('easygo-delivery-charge', deliveryCharge.toString());
        } else {
            localStorage.setItem('easygo-delivery-charge', '0');
        }
        
        // Redirect to payment page
        window.location.href = 'https://clean-scripts.github.io/Easygo-Payment/';
    }

    // ==================== UTILITY FUNCTIONS ====================
    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Save location
                    localStorage.setItem('easygo-user-location', JSON.stringify(userLocation));
                    
                    // Update UI
                    document.getElementById('map').innerHTML = `
                        <div class="bg-green-100 rounded-xl h-64 flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-4xl mb-4">üìç</div>
                                <p class="font-bold text-green-700">Location Captured!</p>
                                <p class="text-sm text-gray-600">Lat: ${userLocation.lat.toFixed(6)}</p>
                                <p class="text-sm text-gray-600">Lng: ${userLocation.lng.toFixed(6)}</p>
                                <button onclick="openAddressPopup()" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg">
                                    Enter Address Details
                                </button>
                            </div>
                        </div>
                    `;
                    
                    showToast('Location captured! Now enter address details.');
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    alert('Unable to get location. Please enter address manually.');
                    openAddressPopup();
                }
            );
        } else {
            alert('Geolocation not supported. Please enter address manually.');
            openAddressPopup();
        }
    }

    function showLoading() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-2xl shadow-lg z-50';
        toast.textContent = message;
        toast.style.animation = 'fadeIn 0.3s, fadeOut 0.3s 2.7s';
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function goBackToCart() {
        window.location.href = 'https://clean-scripts.github.io/Easygo-Cart/';
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('EasyGo Address Page Loading...');
        
        // Initialize Firebase
        initializeFirebase();
        
        // Check cart
        if (checkCartEmpty()) {
            return;
        }
        
        // Show delivery mode popup
        setTimeout(() => {
            document.getElementById('deliveryModePopup').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }, 500);
        
        // Auto-select home address type
        selectAddressType('home');
        
        console.log('Address page initialized successfully');
    });
    </script>
</body>
</html>

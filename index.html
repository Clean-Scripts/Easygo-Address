<script>
    // MASTER KEYS
    const PUBLIC_KEY = "gojfbxfj";
    const PRIVATE_KEY = "e636d3ba-d0fd-4186-98d8-b81a3f656ce3";
    const PROJECT_ID = "694d93d7afdf354b9be19888";
    const CLUSTER = "EasyGoCluster";

    // 1. REFINED SHARE LOGIC (Includes all 9 points + Image)
    function shareBill(d) {
        // Format the items table for WhatsApp
        const itemsList = d.items.map(i => `- ${i.n}: ${i.q} x ${i.r}`).join('\n');
        
        const report = `*EasyGo Professional Report* ðŸ“„\n` +
            `--------------------------\n` +
            `*1. Date:* ${d.date}\n` +
            `*2. Vendor:* ${d.org}\n` +
            `*3. Invoice:* ${d.inv || 'N/A'}\n` +
            `*4. GSTN:* ${d.gstn || 'N/A'}\n` +
            `*5-7. Items:*\n${itemsList}\n` +
            `*8. GST Amount:* â‚¹${d.gst_amount || 0}\n` +
            `*9. TOTAL:* ${d.total}\n` +
            `--------------------------\n` +
            `*View Original Bill:* [Cloud Image Stored]`;

        window.open(`https://wa.me/?text=${encodeURIComponent(report)}`);
    }

    // 2. UPDATED HISTORY (With UI for Edit/Delete/Share)
    async function fetchHistory() {
        const uid = document.getElementById('userId').value;
        if(!uid) return alert("Enter your Private ID to see your data");

        const res = await fetch(`https://cloud.mongodb.com/api/atlas/v1.0/groups/${PROJECT_ID}/clusters/${CLUSTER}/data/find`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ' + btoa(`${PUBLIC_KEY}:${PRIVATE_KEY}`) },
            body: JSON.stringify({ 
                database: "EasyGo-Global", 
                collection: "ledger", 
                filter: { uid: uid } 
            })
        });
        
        const data = await res.json();
        const list = document.getElementById('historyList');
        list.innerHTML = '';

        data.documents.reverse().forEach(doc => {
            const card = document.createElement('div');
            card.className = "bg-white p-5 rounded-[2rem] border shadow-sm space-y-4 mb-4";
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="w-2/3">
                        <p class="text-[9px] font-black text-blue-500 uppercase">${doc.date}</p>
                        <h4 class="text-sm font-black uppercase truncate">${doc.org}</h4>
                        <p class="text-lg font-black text-slate-900">${doc.total}</p>
                    </div>
                    <div class="flex flex-col gap-2">
                        <button onclick='shareBill(${JSON.stringify(doc)})' class="p-3 bg-green-500 text-white rounded-2xl shadow-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" stroke-width="2.5"/></svg>
                        </button>
                        <button onclick="deleteBill('${doc._id}')" class="p-3 bg-red-50 text-red-500 rounded-2xl">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick='editBill(${JSON.stringify(doc)})' class="py-3 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest">Edit Bill</button>
                    <button onclick="window.open('${doc.image}')" class="py-3 bg-slate-100 text-slate-500 rounded-xl text-[10px] font-black uppercase tracking-widest">View Image</button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    // 3. DELETE (Atlas Data API DeleteOne)
    async function deleteBill(id) {
        if(!confirm("Are you sure? This will remove the bill from your private cloud forever.")) return;
        await fetch(`https://cloud.mongodb.com/api/atlas/v1.0/groups/${PROJECT_ID}/clusters/${CLUSTER}/data/deleteOne`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ' + btoa(`${PUBLIC_KEY}:${PRIVATE_KEY}`) },
            body: JSON.stringify({ database: "EasyGo-Global", collection: "ledger", filter: { _id: { "$oid": id } } })
        });
        fetchHistory();
    }

    // 4. EDIT (Reloads into Form)
    function editBill(d) {
        document.getElementById('org').value = d.org;
        document.getElementById('date').value = d.date;
        document.getElementById('inv').value = d.inv || '';
        document.getElementById('gstn').value = d.gstn || '';
        document.getElementById('totalLabel').innerText = d.total;
        
        // Clear and reload items
        document.getElementById('itemsContainer').innerHTML = '';
        d.items.forEach(item => addItemRow(item.n, item.q, item.r));
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>

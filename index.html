<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Go | Address & Delivery</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #ffffff; color: #1a1a1a; min-height: 100vh; }
        .banner-clip { clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%); }
        
        /* Map container */
        #map { 
            height: 400px; 
            width: 100%; 
            border-radius: 1.5rem; 
            overflow: hidden;
            border: 2px solid #f3f4f6;
        }
        
        /* Glass effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        
        /* Progress bar */
        .progress-container {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.5s ease;
        }
        
        /* Custom animations */
        @keyframes pulse-gentle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .pulse-gentle {
            animation: pulse-gentle 2s infinite;
        }
        
        /* Loading animation */
        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Main content spacing */
        .main-content { min-height: calc(100vh - 200px); }
        footer { margin-top: auto; }
        
        /* Custom cursor for map */
        .leaflet-container {
            cursor: crosshair !important;
        }
        
        /* Distance marker */
        .distance-marker {
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 20px;
            padding: 5px 10px;
            font-weight: bold;
            color: #1e40af;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        /* Step indicator */
        .step-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        /* Address suggestion dropdown */
        .suggestion-dropdown {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            z-index: 1000;
            margin-top: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .suggestion-item:hover {
            background: #f8fafc;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">
    
    <!-- Empty Cart Overlay -->
    <div id="emptyCartOverlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-[2.5rem] p-10 max-w-md w-full shadow-2xl text-center border-2 border-gray-100">
            <div class="text-6xl mb-6">üõí</div>
            <h2 class="text-2xl font-black uppercase mb-4">Your Cart is Empty</h2>
            <p class="text-gray-600 mb-6 font-medium">Add delicious items to your cart before proceeding to address details.</p>
            <p class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-8">Redirecting in <span id="countdown" class="text-indigo-600 font-black">5</span> seconds...</p>
            <a href="https://clean-scripts.github.io/Easygo-Menu/" 
               class="inline-flex items-center gap-3 px-8 py-4 bg-indigo-600 text-white font-black uppercase rounded-[2rem] hover:bg-indigo-700 transition-all shadow-lg">
                <i class="fas fa-shopping-cart"></i>
                Back to Menu
            </a>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-[2rem] p-10 shadow-2xl text-center border-2 border-gray-100">
            <div class="loader mx-auto mb-6"></div>
            <p class="text-xl font-black uppercase mb-2">Processing</p>
            <p class="text-gray-600 text-sm font-medium">Please wait while we verify your details...</p>
        </div>
    </div>
    
    <!-- Location First Modal -->
    <div id="locationFirstModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-[2.5rem] p-10 max-w-2xl w-full shadow-2xl text-center border-2 border-gray-100">
            <div class="text-6xl mb-6">üìç</div>
            <h2 class="text-3xl font-black uppercase mb-4 text-indigo-600">Set Your Location First</h2>
            <p class="text-gray-700 mb-6 font-medium text-lg">
                Please set your delivery location on the map before entering address details.
            </p>
            <p class="text-gray-600 mb-6 font-medium">
                This helps us auto-fill your city/state and calculate accurate delivery charges.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <button id="autoLocationModalBtn" 
                        class="flex items-center justify-center gap-4 p-6 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-2xl hover:opacity-90 transition-all shadow-lg">
                    <i class="fas fa-location-crosshairs text-2xl"></i>
                    <div class="text-left">
                        <span class="block text-xl font-black">Auto Location</span>
                        <span class="text-sm opacity-90">Use current GPS</span>
                    </div>
                </button>
                
                <button id="manualLocationModalBtn" 
                        class="flex items-center justify-center gap-4 p-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-2xl hover:opacity-90 transition-all shadow-lg">
                    <i class="fas fa-map-pin text-2xl"></i>
                    <div class="text-left">
                        <span class="block text-xl font-black">Manual Pin</span>
                        <span class="text-sm opacity-90">Click on map</span>
                    </div>
                </button>
            </div>
            <button onclick="skipLocationForNow()" 
                    class="mt-6 px-6 py-3 text-gray-600 hover:text-gray-800 font-medium">
                Skip & Enter Address Manually
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header Banner -->
        <header class="relative mb-8">
            <div class="h-48 md:h-64 overflow-hidden banner-clip">
                <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/Banner.png" 
                     class="w-full h-full object-cover" alt="Easy Go Banner">
            </div>
            <div class="absolute -bottom-6 left-0 right-0 flex justify-center">
                <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                     class="h-32 w-32 rounded-full border-4 border-white shadow-xl bg-white p-1">
            </div>
        </header>

        <!-- Main Container -->
        <div class="max-w-6xl mx-auto px-4 pt-10 pb-12">
            <!-- Page Title -->
            <div class="text-center mb-10">
                <h1 class="text-5xl font-black uppercase tracking-tighter mb-2">Address & Delivery</h1>
                <p class="text-gray-500 uppercase text-sm font-bold tracking-widest">Step 2: Set location & enter details</p>
            </div>

            <!-- Progress Steps -->
            <div class="glass-card rounded-[2rem] p-8 mb-10 border-2 border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="step-indicator bg-green-500 text-white">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <p class="text-xs font-black text-gray-400 uppercase tracking-widest">Step 1</p>
                            <p class="font-bold text-green-600">Cart</p>
                        </div>
                    </div>
                    
                    <div class="flex-1 mx-6">
                        <div class="progress-container">
                            <div class="progress-fill" style="width: 33%"></div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="step-indicator bg-indigo-600 text-white pulse-gentle">
                            2
                        </div>
                        <div>
                            <p class="text-xs font-black text-gray-400 uppercase tracking-widest">Step 2</p>
                            <p class="font-bold text-indigo-600">Address & Location</p>
                        </div>
                    </div>
                    
                    <div class="flex-1 mx-6">
                        <div class="progress-container">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="step-indicator bg-gray-200 text-gray-400">
                            3
                        </div>
                        <div>
                            <p class="text-xs font-black text-gray-400 uppercase tracking-widest">Step 3</p>
                            <p class="font-bold text-gray-400">Payment</p>
                        </div>
                    </div>
                </div>
                
                <!-- Cart Summary -->
                <div class="flex justify-between items-center pt-6 border-t border-gray-100">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-indigo-50 rounded-2xl flex items-center justify-center">
                            <i class="fas fa-shopping-cart text-indigo-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs font-black text-gray-400 uppercase tracking-widest">Cart Total</p>
                            <p id="cart-total-badge" class="text-2xl font-black text-gray-900">‚Çπ0</p>
                        </div>
                    </div>
                    
                    <button onclick="window.location.href='https://clean-scripts.github.io/Easygo-Menu/'" 
                            class="px-6 py-3 bg-gray-900 text-white rounded-2xl font-bold uppercase text-xs hover:bg-black transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>Edit Cart
                    </button>
                </div>
            </div>

            <!-- Delivery Mode Selection -->
            <div class="glass-card rounded-[2rem] p-8 mb-10 border-2 border-gray-100">
                <h2 class="text-2xl font-black uppercase mb-6">Choose Your Option</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Delivery Option -->
                    <div id="delivery-option" 
                         class="border-2 border-indigo-500 bg-indigo-50 rounded-[2rem] p-8 cursor-pointer transition-all duration-300 hover:shadow-xl"
                         onclick="switchToDelivery()">
                        <div class="flex items-center gap-6">
                            <div class="w-20 h-20 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <i class="fas fa-motorcycle text-white text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-black text-xl uppercase mb-2">Home Delivery</h3>
                                <p class="text-indigo-600 font-bold text-sm">Delivered fresh to your doorstep</p>
                                <p class="text-xs text-gray-500 mt-3 font-medium">‚Ä¢ ‚Çπ9 fixed delivery within 1km</p>
                                <p class="text-xs text-gray-500 font-medium">‚Ä¢ Free delivery on orders above ‚Çπ199 (4km+)</p>
                                <p class="text-xs text-gray-500 font-medium">‚Ä¢ Worldwide delivery available</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Takeaway Option -->
                    <div id="takeaway-option" 
                         class="border-2 border-gray-200 rounded-[2rem] p-8 cursor-pointer transition-all duration-300 hover:border-green-500 hover:shadow-xl"
                         onclick="switchToTakeaway()">
                        <div class="flex items-center gap-6">
                            <div class="w-20 h-20 bg-gray-200 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-store text-gray-600 text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-black text-xl uppercase mb-2">Takeaway</h3>
                                <p class="text-gray-600 font-bold text-sm">Pickup from Prime Square</p>
                                <p class="text-xs text-gray-500 mt-3 font-medium">‚Ä¢ No delivery charges</p>
                                <p class="text-xs text-gray-500 font-medium">‚Ä¢ OTP verification at pickup</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <!-- Left Column - Map First -->
                <div class="space-y-10">
                    <!-- Map & Location Section (NOW FIRST) -->
                    <div id="map-section" class="glass-card rounded-[2rem] p-8 border-2 border-gray-100">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 bg-purple-100 rounded-2xl flex items-center justify-center">
                                    <i class="fas fa-map-marker-alt text-purple-600 text-xl"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-black uppercase">Set Delivery Location</h2>
                                    <p class="text-gray-500 text-sm font-medium">Click on map or use auto-location</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-2xl">
                            <p class="text-blue-800 font-medium">
                                <i class="fas fa-info-circle mr-2"></i>
                                Click anywhere on the map to mark your exact delivery location. We deliver worldwide!
                            </p>
                        </div>
                        
                        <div id="map"></div>
                        
                        <!-- Location Action Buttons -->
                        <div class="grid grid-cols-2 gap-4 mt-6">
                            <button id="useCurrentLocationBtn" 
                                    class="flex items-center justify-center gap-3 p-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 transition shadow-lg">
                                <i class="fas fa-location-crosshairs"></i>
                                <span>Auto Location</span>
                            </button>
                            
                            <button id="manualLocationBtn" 
                                    class="flex items-center justify-center gap-3 p-4 bg-purple-600 text-white font-bold rounded-2xl hover:bg-purple-700 transition shadow-lg">
                                <i class="fas fa-map-pin"></i>
                                <span>Drop Pin</span>
                            </button>
                        </div>
                        
                        <!-- Location Status -->
                        <div id="locationStatus" class="mt-6 p-5 bg-green-50 border-2 border-green-200 rounded-2xl hidden">
                            <div class="flex items-center gap-4">
                                <i class="fas fa-check-circle text-2xl text-green-500"></i>
                                <div>
                                    <p class="font-bold text-green-800 text-lg">Location Set Successfully!</p>
                                    <p class="text-sm text-gray-600">
                                        Distance: <span id="previewDistance" class="font-bold">-- km</span> | 
                                        Delivery Charge: <span id="previewCharge" class="font-bold">‚Çπ0</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Address Form (Initially Hidden) -->
                    <div id="address-form-section" class="glass-card rounded-[2rem] p-8 border-2 border-gray-100 hidden">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-home text-indigo-600 text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-black uppercase">Delivery Address</h2>
                                <p class="text-gray-500 text-sm font-medium">We've auto-filled city/state from your location</p>
                            </div>
                        </div>
                        
                        <form id="addressForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Name -->
                                <div class="md:col-span-2">
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Full Name *</label>
                                    <input type="text" 
                                           id="name" 
                                           required
                                           class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                                           placeholder="Your full name">
                                </div>
                                
                                <!-- Phone Number -->
                                <div class="md:col-span-2">
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Phone Number *</label>
                                    <input type="tel" 
                                           id="phone" 
                                           required
                                           pattern="[0-9]{10}"
                                           class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                                           placeholder="10-digit WhatsApp number">
                                </div>
                                
                                <!-- Address Type -->
                                <div class="md:col-span-2">
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Address Type *</label>
                                    <select id="addressType" 
                                            required
                                            class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium bg-white appearance-none">
                                        <option value="" disabled selected>Select address type</option>
                                        <option value="Flat">Flat / Apartment</option>
                                        <option value="House">House</option>
                                        <option value="Office">Office</option>
                                        <option value="Hostel">Hostel</option>
                                        <option value="PG">P.G. Accommodation</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <!-- House Number -->
                                <div>
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">House/Flat No. *</label>
                                    <input type="text" 
                                           id="houseNumber" 
                                           required
                                           class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                                           placeholder="e.g., A-102">
                                </div>
                                
                                <!-- Floor Number -->
                                <div>
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Floor No. (Optional)</label>
                                    <input type="text" 
                                           id="floorNumber"
                                           class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                                           placeholder="e.g., 3rd floor">
                                </div>
                                
                                <!-- Building/Society Name -->
                                <div class="md:col-span-2">
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Building/Society Name</label>
                                    <input type="text" 
                                           id="buildingName"
                                           class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                                           placeholder="Apartment or society name (optional)">
                                </div>
                                
                                <!-- Street/Area -->
                                <div class="md:col-span-2">
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Street / Area *</label>
                                    <div class="relative">
                                        <input type="text" 
                                               id="street" 
                                               required
                                               class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                                               placeholder="Start typing your street or area...">
                                        <div id="suggestionsDropdown" class="suggestion-dropdown hidden"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2 font-medium">
                                        Start typing and select from suggestions. We'll auto-fill after location is set.
                                    </p>
                                </div>
                                
                                <!-- Pincode -->
                                <div class="md:col-span-2">
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Pincode *</label>
                                    <input type="text" 
                                           id="pincode" 
                                           required
                                           maxlength="6"
                                           pattern="[0-9]{6}"
                                           class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium"
                                           placeholder="6-digit pincode">
                                </div>
                                
                                <!-- City (Auto-filled, read-only initially) -->
                                <div>
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">City *</label>
                                    <input type="text" 
                                           id="city" 
                                           required
                                           readonly
                                           class="w-full p-4 border-2 border-gray-200 bg-gray-50 rounded-2xl font-medium"
                                           placeholder="Auto-filled from location">
                                </div>
                                
                                <!-- State (Auto-filled, read-only initially) -->
                                <div>
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">State *</label>
                                    <input type="text" 
                                           id="state" 
                                           required
                                           readonly
                                           class="w-full p-4 border-2 border-gray-200 bg-gray-50 rounded-2xl font-medium"
                                           placeholder="Auto-filled from location">
                                </div>
                                
                                <!-- Country (Auto-filled) -->
                                <div class="md:col-span-2">
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Country</label>
                                    <input type="text" 
                                           id="country" 
                                           value="India"
                                           readonly
                                           class="w-full p-4 border-2 border-gray-200 bg-gray-50 rounded-2xl font-medium">
                                </div>
                                
                                <!-- Additional Instructions -->
                                <div class="md:col-span-2">
                                    <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Delivery Instructions (Optional)</label>
                                    <textarea id="instructions"
                                              rows="3"
                                              class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium resize-none"
                                              placeholder="Any special delivery instructions? (gate code, landmark, etc.)"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Takeaway Form -->
                    <div id="takeaway-form-section" class="glass-card rounded-[2rem] p-8 border-2 border-gray-100 hidden">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-store text-green-600 text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-black uppercase">Takeaway Details</h2>
                                <p class="text-gray-500 text-sm font-medium">Pickup from our kitchen</p>
                            </div>
                        </div>
                        
                        <div class="mb-8 p-6 bg-green-50 border-2 border-green-200 rounded-2xl">
                            <h3 class="font-bold text-green-800 mb-4 text-lg uppercase">üìç Pickup Information</h3>
                            <div class="space-y-3 text-green-700">
                                <p class="flex items-center gap-3">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span><strong>Address:</strong> Prime Square, Omaxe City 1, Indore</span>
                                </p>
                                <p class="flex items-center gap-3">
                                    <i class="fas fa-clock"></i>
                                    <span><strong>Timings:</strong> 5:45 PM - 10:30 PM</span>
                                </p>
                                <p class="flex items-center gap-3">
                                    <i class="fas fa-mobile-alt"></i>
                                    <span><strong>OTP Verification:</strong> Required at pickup counter</span>
                                </p>
                            </div>
                        </div>
                        
                        <form id="takeawayForm" class="space-y-6">
                            <div>
                                <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Your Name *</label>
                                <input type="text" 
                                       id="takeaway-name" 
                                       required
                                       class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition font-medium"
                                       placeholder="Your full name">
                            </div>
                            
                            <div>
                                <label class="text-xs font-black uppercase text-gray-400 mb-2 block">Phone Number *</label>
                                <input type="tel" 
                                       id="takeaway-phone" 
                                       required
                                       pattern="[0-9]{10}"
                                       class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition font-medium"
                                       placeholder="10-digit WhatsApp number">
                                <p class="text-xs text-gray-500 mt-2 font-medium">This number will be used for OTP verification at pickup</p>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Right Column - Summary & Charges -->
                <div class="space-y-10">
                    <!-- Delivery Charges Card -->
                    <div id="deliveryChargesCard" class="glass-card rounded-[2rem] p-8 border-2 border-gray-100 hidden">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-truck text-indigo-600 text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-black uppercase">Delivery Summary</h2>
                                <p class="text-gray-500 text-sm font-medium">Your delivery charges breakdown</p>
                            </div>
                        </div>
                        
                        <!-- Distance Display -->
                        <div class="mb-8 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-2xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700 text-lg">Distance from Prime Square</p>
                                    <p id="locationAddress" class="text-sm text-indigo-600 font-medium">Location not set</p>
                                </div>
                                <span id="distanceValue" class="text-4xl font-black text-indigo-700">-- km</span>
                            </div>
                        </div>
                        
                        <!-- Charges Breakdown -->
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-5 bg-gray-50 rounded-2xl">
                                <span class="font-bold text-gray-700">Base Fare</span>
                                <span id="baseFare" class="font-black text-gray-900 text-xl">‚Çπ0</span>
                            </div>
                            
                            <div class="flex justify-between items-center p-5 bg-gray-50 rounded-2xl">
                                <span class="font-bold text-gray-700">GST (18%)</span>
                                <span id="gstValue" class="font-black text-gray-900 text-xl">‚Çπ0</span>
                            </div>
                            
                            <div class="border-t-2 border-gray-200 pt-6 mt-6">
                                <div class="flex justify-between items-center p-6 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl">
                                    <div>
                                        <p class="font-black text-gray-900 text-lg uppercase">Total Delivery Charge</p>
                                        <p class="text-sm text-green-600 font-medium">Inclusive of all taxes</p>
                                    </div>
                                    <span id="totalCharge" class="font-black text-green-700 text-3xl">‚Çπ0</span>
                                </div>
                            </div>
                            
                            <!-- Free Delivery Offer -->
                            <div id="freeDeliveryOffer" class="p-5 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl hidden">
                                <div class="flex items-center gap-4">
                                    <i class="fas fa-gift text-green-500 text-2xl"></i>
                                    <div>
                                        <p class="font-black text-green-800 text-lg uppercase">üéâ FREE DELIVERY!</p>
                                        <p class="text-sm text-green-700 font-medium">Your order qualifies for free delivery</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fixed ‚Çπ9 Delivery -->
                            <div id="fixedDeliveryMessage" class="p-5 bg-blue-50 border-2 border-blue-200 rounded-2xl hidden">
                                <div class="flex items-center gap-4">
                                    <i class="fas fa-tag text-blue-500 text-2xl"></i>
                                    <div>
                                        <p class="font-black text-blue-800 text-lg uppercase">üéØ FIXED ‚Çπ9 DELIVERY!</p>
                                        <p class="text-sm text-blue-700 font-medium">Within 1km from outlet - regardless of order value!</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Worldwide Delivery -->
                            <div id="worldwideDeliveryMessage" class="p-5 bg-purple-50 border-2 border-purple-200 rounded-2xl hidden">
                                <div class="flex items-center gap-4">
                                    <i class="fas fa-globe text-purple-500 text-2xl"></i>
                                    <div>
                                        <p class="font-black text-purple-800 text-lg uppercase">üåç WORLDWIDE DELIVERY!</p>
                                        <p class="text-sm text-purple-700 font-medium">We deliver anywhere in the world!</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Button -->
                            <button id="proceedToPaymentBtn" 
                                    class="w-full mt-10 flex items-center justify-center gap-4 p-5 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black uppercase rounded-2xl hover:opacity-90 transition-all shadow-lg text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-check-circle text-xl"></i>
                                <span>Proceed to Payment</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Takeaway Action Card -->
                    <div id="takeawayActionCard" class="glass-card rounded-[2rem] p-8 border-2 border-gray-100 hidden">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-store text-green-600 text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-black uppercase">Takeaway Ready!</h2>
                                <p class="text-gray-500 text-sm font-medium">Pickup from our kitchen</p>
                            </div>
                        </div>
                        
                        <div class="mb-8 p-6 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl">
                            <div class="space-y-4">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-map-marker-alt text-green-500"></i>
                                    <div>
                                        <p class="text-xs font-black text-gray-600 uppercase">Pickup Location</p>
                                        <p class="font-bold text-green-700">Prime Square, Omaxe City 1, Indore</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-clock text-green-500"></i>
                                    <div>
                                        <p class="text-xs font-black text-gray-600 uppercase">Pickup Time</p>
                                        <p class="font-bold text-green-700">5:45 PM - 10:30 PM</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="proceedToPaymentTakeawayBtn" 
                                class="w-full flex items-center justify-center gap-4 p-5 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black uppercase rounded-2xl hover:opacity-90 transition-all shadow-lg text-lg">
                            <i class="fas fa-check-circle text-xl"></i>
                            <span>Proceed to Payment</span>
                        </button>
                        
                        <button id="switchToDeliveryBtn" 
                                class="w-full mt-4 flex items-center justify-center gap-3 p-4 bg-indigo-50 border-2 border-indigo-200 text-indigo-700 font-bold rounded-2xl hover:bg-indigo-100 transition">
                            <i class="fas fa-motorcycle"></i>
                            <span>Switch to Delivery</span>
                        </button>
                    </div>
                    
                    <!-- Location Info Card (for Takeaway) -->
                    <div id="locationInfoCard" class="glass-card rounded-[2rem] p-8 border-2 border-gray-100 hidden">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-14 h-14 bg-purple-100 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-info-circle text-purple-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-black uppercase">How Location Works</h3>
                                <p class="text-gray-500 text-sm font-medium">Simple 3-step process</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-2xl">
                                <div class="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                                <div>
                                    <p class="font-bold text-gray-800">Click on map</p>
                                    <p class="text-sm text-gray-600">Click anywhere on the map to set your exact delivery point</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-2xl">
                                <div class="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">2</div>
                                <div>
                                    <p class="font-bold text-gray-800">Auto-fill address</p>
                                    <p class="text-sm text-gray-600">We'll automatically fill city, state, and suggest street names</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-2xl">
                                <div class="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">3</div>
                                <div>
                                    <p class="font-bold text-gray-800">Complete details</p>
                                    <p class="text-sm text-gray-600">Just add house number and finalize your address</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-12 w-12 rounded-full bg-white p-1 mr-3">
                        <div>
                            <h2 class="text-xl font-bold">Easy Go</h2>
                            <p class="text-gray-400 text-sm">Delivering Freshness & Speed !</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-center">
                    <p class="text-gray-400 text-sm mb-2">
                        ¬© 2024 Easy Go | All Rights Reserved
                    </p>
                    <div class="mt-4">
                        <a href="https://clean-scripts.github.io/Easygo-Menu/" class="text-gray-400 hover:text-white text-sm mr-4">View Menu</a>
                        <a href="https://clean-scripts.github.io/Easygo-Privacy/" class="text-gray-400 hover:text-white text-sm mr-4">Privacy Policy</a>
                        <a href="https://clean-scripts.github.io/Easygo-Terms/" class="text-gray-400 hover:text-white text-sm">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

<script>
    // Global variables
    let map;
    let userMarker;
    let userLocation = null;
    let deliveryMode = 'delivery';
    let locationSet = false;
    let geocoder;
    
    // Restaurant location (Prime Square, Indore)
    const primeSquareLocation = [22.7767737, 75.9605483];
    
    // ====== MAIN INITIALIZATION ======
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Easy Go Address Page Loading...");
        
        // Check cart first
        if (checkCartEmpty()) {
            console.log("Cart empty - stopping");
            return;
        }
        
        // Initialize the page
        initializePage();
    });
    
    function initializePage() {
        console.log("Initializing page...");
        
        // 1. Load cart total
        loadCartTotal();
        
        // 2. Initialize map immediately (NO circles)
        console.log("Initializing map...");
        setTimeout(() => {
            initMap();
        }, 100);
        
        // 3. Show location modal for delivery mode
        setTimeout(() => {
            if (deliveryMode === 'delivery') {
                showLocationFirstModal();
            }
        }, 500);
        
        // 4. Setup event listeners
        setupEventListeners();
        
        console.log("Page initialization complete");
    }
    
    // ====== SHOW LOCATION FIRST MODAL ======
    function showLocationFirstModal() {
        document.getElementById('locationFirstModal').classList.remove('hidden');
    }
    
    function skipLocationForNow() {
        document.getElementById('locationFirstModal').classList.add('hidden');
        // Make city/state editable
        document.getElementById('city').readOnly = false;
        document.getElementById('city').classList.remove('bg-gray-50');
        document.getElementById('state').readOnly = false;
        document.getElementById('state').classList.remove('bg-gray-50');
        
        // Show address form
        document.getElementById('address-form-section').classList.remove('hidden');
        document.getElementById('locationInfoCard').classList.remove('hidden');
    }
    
    // ====== INITIALIZE MAP (WITHOUT CIRCLES) ======
    function initMap() {
        try {
            console.log("Initializing map...");
            
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.error("Map container not found!");
                setTimeout(initMap, 500);
                return;
            }
            
            if (typeof L === 'undefined') {
                console.error("Leaflet library not loaded!");
                setTimeout(initMap, 500);
                return;
            }
            
            // Clear existing map
            if (map) {
                try {
                    map.remove();
                } catch (e) {
                    console.log("Error removing old map:", e);
                }
                map = null;
            }
            
            // Initialize map with worldwide view
            map = L.map('map', {
                center: [20.5937, 78.9629], // Center of India
                zoom: 4,
                zoomControl: true,
                scrollWheelZoom: true
            });
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
                minZoom: 2
            }).addTo(map);
            
            // Add restaurant marker
            L.marker(primeSquareLocation, {
                icon: L.divIcon({
                    className: 'restaurant-marker',
                    html: '<div class="bg-indigo-600 text-white p-3 rounded-full shadow-lg">üè™</div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                })
            }).addTo(map)
                .bindPopup('<b>EasyGo Restaurant</b><br>üìç Prime Square, Indore<br>üìç Our Kitchen')
                .openPopup();
            
            // Add click event for manual pin drop
            map.on('click', function(e) {
                if (deliveryMode === 'delivery') {
                    setUserLocation(e.latlng.lat, e.latlng.lng);
                    document.getElementById('locationFirstModal').classList.add('hidden');
                }
            });
            
            // Add click instructions
            L.control.attribution({
                position: 'bottomright',
                prefix: '<span style="color: #666; font-size: 12px;">Click anywhere on map to set location</span>'
            }).addTo(map);
            
            // Force map resize
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    console.log("Map initialized successfully");
                }
            }, 300);
            
        } catch (error) {
            console.error("Error initializing map:", error);
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center bg-gray-100 rounded-2xl p-8">
                        <div class="text-4xl mb-4">üó∫Ô∏è</div>
                        <p class="font-bold text-gray-700">Map Loading Error</p>
                        <button onclick="initMap()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold">
                            Retry Loading Map
                        </button>
                    </div>
                `;
            }
        }
    }
    
    // ====== SET USER LOCATION ======
    async function setUserLocation(lat, lng) {
        try {
            console.log("Setting user location:", lat, lng);
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            userLocation = { lat, lng };
            locationSet = true;
            
            // Remove existing marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // Create new marker
            userMarker = L.marker([lat, lng], { 
                draggable: true,
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background: #8b5cf6; width: 50px; height: 50px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">üìç</div>',
                    iconSize: [50, 50],
                    iconAnchor: [25, 50]
                })
            }).addTo(map);
            
            // Center and zoom map to user location
            map.setView([lat, lng], 16);
            
            // Add distance line and label
            const distance = calculateDistance(primeSquareLocation[0], primeSquareLocation[1], lat, lng);
            const line = L.polyline([primeSquareLocation, [lat, lng]], {
                color: '#3b82f6',
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map);
            
            // Add distance label at midpoint
            const midPoint = [
                (primeSquareLocation[0] + lat) / 2,
                (primeSquareLocation[1] + lng) / 2
            ];
            
            L.marker(midPoint, {
                icon: L.divIcon({
                    className: 'distance-marker',
                    html: `<div>${distance.toFixed(1)} km</div>`,
                    iconSize: [80, 30],
                    iconAnchor: [40, 15]
                })
            }).addTo(map);
            
            // Auto-fill address using reverse geocoding
            await reverseGeocode(lat, lng);
            
            // Update delivery charges
            updateDeliveryCharges();
            
            // Show address form and hide location info
            document.getElementById('address-form-section').classList.remove('hidden');
            document.getElementById('locationInfoCard').classList.add('hidden');
            
            // Show status
            document.getElementById('locationStatus').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('hidden');
            
            // Add dragend event for marker
            userMarker.on('dragend', async function() {
                const position = userMarker.getLatLng();
                userLocation = { lat: position.lat, lng: position.lng };
                
                // Remove old line and marker
                map.removeLayer(line);
                
                // Update distance
                const newDistance = calculateDistance(primeSquareLocation[0], primeSquareLocation[1], position.lat, position.lng);
                
                // Add new line
                L.polyline([primeSquareLocation, [position.lat, position.lng]], {
                    color: '#3b82f6',
                    weight: 2,
                    dashArray: '5, 5'
                }).addTo(map);
                
                // Update address
                await reverseGeocode(position.lat, position.lng);
                updateDeliveryCharges();
            });
            
            console.log("User location set successfully");
            
        } catch (error) {
            console.error("Error setting user location:", error);
            alert("Error setting location. Please try again.");
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    }
    
    // ====== ENHANCED REVERSE GEOCODING ======
    async function reverseGeocode(lat, lng) {
        try {
            // Use Nominatim for worldwide geocoding
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
            );
            
            if (!response.ok) throw new Error('Geocoding failed');
            
            const data = await response.json();
            
            if (data.address) {
                const address = data.address;
                
                // Auto-fill city (prioritize different fields)
                let city = address.city || address.town || address.village || 
                          address.municipality || address.county || address.state_district || '';
                
                // Auto-fill state
                let state = address.state || address.region || '';
                
                // Auto-fill country
                let country = address.country || 'India';
                
                // Auto-fill pincode if available
                if (address.postcode) {
                    document.getElementById('pincode').value = address.postcode;
                }
                
                // Fill city and state (make editable)
                document.getElementById('city').value = city;
                document.getElementById('city').readOnly = false;
                document.getElementById('city').classList.remove('bg-gray-50');
                
                document.getElementById('state').value = state;
                document.getElementById('state').readOnly = false;
                document.getElementById('state').classList.remove('bg-gray-50');
                
                document.getElementById('country').value = country;
                
                // Suggest street/area
                let street = address.road || address.footway || address.pedestrian || 
                           address.neighbourhood || address.suburb || address.city_district || '';
                
                document.getElementById('street').value = street;
                document.getElementById('street').placeholder = "Add more details to your street address";
                
                // Update location address preview
                document.getElementById('locationAddress').textContent = 
                    `${street ? street + ', ' : ''}${city ? city + ', ' : ''}${state ? state : ''}`;
                
                console.log("Auto-filled address:", { city, state, country, street });
            }
            
        } catch (error) {
            console.error("Reverse geocoding error:", error);
            // Keep fields editable if geocoding fails
            document.getElementById('city').readOnly = false;
            document.getElementById('city').classList.remove('bg-gray-50');
            document.getElementById('state').readOnly = false;
            document.getElementById('state').classList.remove('bg-gray-50');
        }
    }
    
    // ====== CALCULATE DISTANCE ======
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in kilometers
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        console.log(`Distance: ${distance.toFixed(2)} km`);
        return distance;
    }
    
    // ====== CALCULATE DELIVERY CHARGES ======
    function calculateDeliveryCharges(distance) {
        console.log(`Calculating charges for distance: ${distance} km`);
        
        const cartTotal = parseFloat(localStorage.getItem('easygo-cart-items-total')) || 0;
        
        // Fixed ‚Çπ9 delivery within 1km (REGARDLESS of cart total)
        if (distance <= 1) {
            console.log("Within 1km: Fixed ‚Çπ9 delivery");
            const baseCharge = 9;
            const gst = baseCharge * 0.18;
            const totalCharge = baseCharge + gst;
            
            return {
                distance: distance.toFixed(1),
                baseCharge: baseCharge,
                gst: gst.toFixed(2),
                totalCharge: totalCharge.toFixed(2),
                fixedDelivery: true,
                freeDelivery: false
            };
        }
        
        // Free delivery for orders above ‚Çπ199 (for distances > 1km)
        const freeDeliveryEligible = cartTotal > 199;
        
        if (freeDeliveryEligible) {
            console.log("Free delivery: Order > ‚Çπ199");
            const baseCharge = 0;
            const gst = 0;
            const totalCharge = 0;
            
            return {
                distance: distance.toFixed(1),
                baseCharge: baseCharge,
                gst: gst.toFixed(2),
                totalCharge: totalCharge.toFixed(2),
                fixedDelivery: false,
                freeDelivery: true
            };
        }
        
        // Standard delivery charges for distances > 1km
        let baseCharge = 0;
        
        if (distance <= 4) {
            baseCharge = 20;
        } else if (distance <= 6) {
            baseCharge = 30;
        } else if (distance <= 8) {
            baseCharge = 40;
        } else if (distance <= 10) {
            baseCharge = 50;
        } else {
            // Beyond 10km - worldwide delivery with calculated charge
            baseCharge = Math.ceil(distance * 5); // ‚Çπ5 per km for long distances
            if (baseCharge < 60) baseCharge = 60; // Minimum ‚Çπ60 for long distance
        }
        
        const gst = baseCharge * 0.18;
        const totalCharge = baseCharge + gst;
        
        return {
            distance: distance.toFixed(1),
            baseCharge: baseCharge,
            gst: gst.toFixed(2),
            totalCharge: totalCharge.toFixed(2),
            fixedDelivery: false,
            freeDelivery: false
        };
    }
    
    // ====== UPDATE DELIVERY CHARGES DISPLAY ======
    function updateDeliveryCharges() {
        if (!userLocation) {
            console.log("No user location set");
            return;
        }
        
        const distance = calculateDistance(
            primeSquareLocation[0], primeSquareLocation[1],
            userLocation.lat, userLocation.lng
        );
        
        const charges = calculateDeliveryCharges(distance);
        
        // Update UI
        document.getElementById('distanceValue').textContent = `${charges.distance} km`;
        document.getElementById('previewDistance').textContent = `${charges.distance} km`;
        document.getElementById('previewCharge').textContent = `‚Çπ${charges.totalCharge}`;
        document.getElementById('baseFare').textContent = `‚Çπ${charges.baseCharge}`;
        document.getElementById('gstValue').textContent = `‚Çπ${charges.gst}`;
        document.getElementById('totalCharge').textContent = `‚Çπ${charges.totalCharge}`;
        
        // Show appropriate messages
        document.getElementById('freeDeliveryOffer').classList.add('hidden');
        document.getElementById('fixedDeliveryMessage').classList.add('hidden');
        document.getElementById('worldwideDeliveryMessage').classList.add('hidden');
        
        if (charges.fixedDelivery) {
            document.getElementById('fixedDeliveryMessage').classList.remove('hidden');
        } else if (charges.freeDelivery) {
            document.getElementById('freeDeliveryOffer').classList.remove('hidden');
        } else if (parseFloat(charges.distance) > 10) {
            document.getElementById('worldwideDeliveryMessage').classList.remove('hidden');
        }
        
        // Show delivery charges card
        document.getElementById('deliveryChargesCard').classList.remove('hidden');
        document.getElementById('proceedToPaymentBtn').disabled = false;
        document.getElementById('proceedToPaymentBtn').classList.remove('opacity-50', 'cursor-not-allowed');
        
        // Save delivery data
        const deliveryData = {
            mode: 'delivery',
            distance: charges.distance,
            charge: charges.totalCharge,
            location: userLocation,
            isFixedDelivery: charges.fixedDelivery || false
        };
        localStorage.setItem('easygo-delivery', JSON.stringify(deliveryData));
        
        console.log("Delivery charges updated successfully");
    }
    
    // ====== GET CURRENT LOCATION ======
    function getCurrentLocation() {
        if (deliveryMode === 'takeaway') return;
        
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    await setUserLocation(lat, lng);
                    document.getElementById('locationFirstModal').classList.add('hidden');
                },
                (error) => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    console.error("Geolocation error:", error);
                    
                    if (error.code === error.PERMISSION_DENIED) {
                        alert("Location access denied. Please click on the map to set your location.");
                    } else {
                        alert("Unable to get location. Please click on the map.");
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            document.getElementById('loadingOverlay').classList.add('hidden');
            alert("Geolocation not supported. Please click on the map to set location.");
        }
    }
    
    // ====== SETUP EVENT LISTENERS ======
    function setupEventListeners() {
        console.log("Setting up event listeners...");
        
        // Modal location buttons
        document.getElementById('autoLocationModalBtn').addEventListener('click', getCurrentLocation);
        document.getElementById('manualLocationModalBtn').addEventListener('click', function() {
            document.getElementById('locationFirstModal').classList.add('hidden');
            alert("Click anywhere on the map to set your exact delivery location.");
        });
        
        // Regular location buttons
        document.getElementById('useCurrentLocationBtn').addEventListener('click', getCurrentLocation);
        document.getElementById('manualLocationBtn').addEventListener('click', function() {
            alert("Click anywhere on the map to set your exact delivery location.");
        });
        
        // Street address suggestions
        document.getElementById('street').addEventListener('input', debounce(async function() {
            const query = this.value;
            if (query.length < 3) return;
            
            try {
                // Use OpenStreetMap Nominatim for address suggestions
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    showAddressSuggestions(data);
                }
            } catch (error) {
                console.error("Address suggestion error:", error);
            }
        }, 300));
        
        // Proceed to payment (delivery)
        document.getElementById('proceedToPaymentBtn').addEventListener('click', function() {
            if (!validateForm()) return;
            if (!userLocation) {
                alert('Please set your delivery location first');
                return;
            }
            
            saveAddressToStorage(getAddressData());
            window.location.href = 'https://clean-scripts.github.io/Easygo-Payment/';
        });
        
        // Proceed to payment (takeaway)
        document.getElementById('proceedToPaymentTakeawayBtn').addEventListener('click', function() {
            if (!validateTakeawayForm()) return;
            saveAddressToStorage(getTakeawayData());
            window.location.href = 'https://clean-scripts.github.io/Easygo-Payment/';
        });
        
        // Switch to delivery from takeaway
        document.getElementById('switchToDeliveryBtn').addEventListener('click', function() {
            switchToDelivery();
            showLocationFirstModal();
        });
    }
    
    // ====== ADDRESS SUGGESTIONS ======
    function showAddressSuggestions(suggestions) {
        const dropdown = document.getElementById('suggestionsDropdown');
        if (!suggestions || suggestions.length === 0) {
            dropdown.classList.add('hidden');
            return;
        }
        
        let html = '';
        suggestions.forEach((item, index) => {
            const displayName = item.display_name.split(',')[0]; // Get first part only
            html += `
                <div class="suggestion-item" data-index="${index}" onclick="selectAddressSuggestion(${index})">
                    <div class="font-medium">${displayName}</div>
                    <div class="text-xs text-gray-500">${item.display_name.substring(displayName.length + 2, 100)}...</div>
                </div>
            `;
        });
        
        dropdown.innerHTML = html;
        dropdown.classList.remove('hidden');
    }
    
    function selectAddressSuggestion(index) {
        // This would populate more address details from the selected suggestion
        // For now, just hide the dropdown
        document.getElementById('suggestionsDropdown').classList.add('hidden');
    }
    
    // ====== DEBOUNCE FUNCTION ======
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // ====== VALIDATION FUNCTIONS ======
    function validateForm() {
        const requiredFields = ['name', 'phone', 'addressType', 'houseNumber', 'street', 'pincode', 'city', 'state'];
        let isValid = true;
        
        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                field.classList.add('border-red-500');
                setTimeout(() => field.classList.remove('border-red-500'), 500);
                if (isValid) {
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    isValid = false;
                }
            }
        }
        
        if (!isValid) {
            alert('Please fill all required fields marked with *');
            return false;
        }
        
        const phone = document.getElementById('phone').value;
        if (!/^\d{10}$/.test(phone)) {
            alert('Please enter valid 10-digit phone number');
            document.getElementById('phone').classList.add('border-red-500');
            return false;
        }
        
        const pincode = document.getElementById('pincode').value;
        if (!/^\d{6}$/.test(pincode)) {
            alert('Please enter valid 6-digit pincode');
            document.getElementById('pincode').classList.add('border-red-500');
            return false;
        }
        
        return true;
    }
    
    function validateTakeawayForm() {
        const name = document.getElementById('takeaway-name').value;
        const phone = document.getElementById('takeaway-phone').value;
        
        if (!name.trim()) {
            alert('Please enter your name for takeaway');
            document.getElementById('takeaway-name').classList.add('border-red-500');
            return false;
        }
        
        if (!/^\d{10}$/.test(phone)) {
            alert('Please enter valid 10-digit phone number for OTP verification');
            document.getElementById('takeaway-phone').classList.add('border-red-500');
            return false;
        }
        
        return true;
    }
    
    // ====== MODE SWITCHING FUNCTIONS ======
    function switchToDelivery() {
        deliveryMode = 'delivery';
        
        // Update UI
        document.getElementById('delivery-option').classList.add('border-indigo-500', 'bg-indigo-50');
        document.getElementById('delivery-option').classList.remove('border-gray-200');
        document.getElementById('takeaway-option').classList.add('border-gray-200');
        document.getElementById('takeaway-option').classList.remove('border-green-500', 'bg-green-50');
        
        // Show map, hide takeaway
        document.getElementById('map-section').classList.remove('hidden');
        document.getElementById('takeaway-form-section').classList.add('hidden');
        document.getElementById('takeawayActionCard').classList.add('hidden');
        document.getElementById('locationInfoCard').classList.remove('hidden');
        
        // Hide address form initially (until location is set)
        document.getElementById('address-form-section').classList.add('hidden');
        document.getElementById('deliveryChargesCard').classList.add('hidden');
        
        // Reset location
        locationSet = false;
        userLocation = null;
        
        // Show location modal
        setTimeout(() => {
            showLocationFirstModal();
        }, 100);
        
        // Ensure map is visible
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
                map.setView([20.5937, 78.9629], 4); // Reset to India view
            }
        }, 300);
    }
    
    function switchToTakeaway() {
        deliveryMode = 'takeaway';
        
        // Update UI
        document.getElementById('takeaway-option').classList.add('border-green-500', 'bg-green-50');
        document.getElementById('takeaway-option').classList.remove('border-gray-200');
        document.getElementById('delivery-option').classList.add('border-gray-200');
        document.getElementById('delivery-option').classList.remove('border-indigo-500', 'bg-indigo-50');
        
        // Show takeaway, hide map
        document.getElementById('map-section').classList.add('hidden');
        document.getElementById('takeaway-form-section').classList.remove('hidden');
        document.getElementById('takeawayActionCard').classList.remove('hidden');
        document.getElementById('address-form-section').classList.add('hidden');
        document.getElementById('deliveryChargesCard').classList.add('hidden');
        document.getElementById('locationInfoCard').classList.add('hidden');
        document.getElementById('locationStatus').classList.add('hidden');
        
        // Save takeaway data
        localStorage.setItem('easygo-delivery', JSON.stringify({
            mode: 'takeaway',
            charge: 0
        }));
    }
    
    // ====== DATA GETTERS ======
    function getAddressData() {
        return {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            addressType: document.getElementById('addressType').value,
            houseNumber: document.getElementById('houseNumber').value,
            floorNumber: document.getElementById('floorNumber').value,
            buildingName: document.getElementById('buildingName').value,
            street: document.getElementById('street').value,
            pincode: document.getElementById('pincode').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            country: document.getElementById('country').value,
            instructions: document.getElementById('instructions').value,
            deliveryMode: 'delivery',
            location: userLocation
        };
    }
    
    function getTakeawayData() {
        return {
            name: document.getElementById('takeaway-name').value,
            phone: document.getElementById('takeaway-phone').value,
            pickupLocation: 'Prime Square, Omaxe City 1, Indore',
            timings: '5:45 PM - 10:30 PM',
            deliveryMode: 'takeaway'
        };
    }
    
    // ====== SAVE ADDRESS ======
    function saveAddressToStorage(address) {
        try {
            localStorage.setItem('easygo-address', JSON.stringify(address));
            localStorage.setItem('easygo-saved-address', JSON.stringify(address));
            console.log("Address saved:", address);
        } catch (error) {
            console.error("Error saving address:", error);
        }
    }
    
    // ====== CART FUNCTIONS ======
    function checkCartEmpty() {
        try {
            const cart = JSON.parse(localStorage.getItem('easygo-cart') || '[]');
            const cartTotal = parseFloat(localStorage.getItem('easygo-cart-items-total') || '0');
            
            console.log("Cart check:", cart.length, "items, total:", cartTotal);
            
            if (cart.length === 0 || cartTotal <= 0) {
                console.log("Cart is empty - showing overlay");
                document.getElementById('emptyCartOverlay').classList.remove('hidden');
                
                let seconds = 5;
                const countdownElement = document.getElementById('countdown');
                countdownElement.textContent = seconds;
                
                const countdown = setInterval(() => {
                    seconds--;
                    countdownElement.textContent = seconds;
                    
                    if (seconds <= 0) {
                        clearInterval(countdown);
                        window.location.href = 'https://clean-scripts.github.io/Easygo-Menu/';
                    }
                }, 1000);
                
                return true;
            }
            
            return false;
        } catch (error) {
            console.error("Error checking cart:", error);
            return false;
        }
    }
    
    function loadCartTotal() {
        const cartTotal = localStorage.getItem('easygo-cart-items-total') || '0';
        document.getElementById('cart-total-badge').textContent = `‚Çπ${cartTotal}`;
        console.log("Cart total loaded:", cartTotal);
    }
</script>
    
</body>
</html>
